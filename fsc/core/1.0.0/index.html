<!DOCTYPE html><html lang="en"><head>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta content="text/html; charset=utf-8" http-equiv="content-type">
<meta name="generator" content="ReSpec 35.1.1">
<style>
dfn{cursor:pointer}
.dfn-panel{position:absolute;z-index:35;min-width:300px;max-width:500px;padding:.5em .75em;margin-top:.6em;font-family:"Helvetica Neue",sans-serif;font-size:small;background:#fff;background:var(--indextable-hover-bg,#fff);color:#000;color:var(--text,#000);box-shadow:0 1em 3em -.4em rgba(0,0,0,.3),0 0 1px 1px rgba(0,0,0,.05);box-shadow:0 1em 3em -.4em var(--tocsidebar-shadow,rgba(0,0,0,.3)),0 0 1px 1px var(--tocsidebar-shadow,rgba(0,0,0,.05));border-radius:2px}
.dfn-panel:not(.docked)>.caret{position:absolute;top:-9px}
.dfn-panel:not(.docked)>.caret::after,.dfn-panel:not(.docked)>.caret::before{content:"";position:absolute;border:10px solid transparent;border-top:0;border-bottom:10px solid #fff;border-bottom-color:var(--indextable-hover-bg,#fff);top:0}
.dfn-panel:not(.docked)>.caret::before{border-bottom:9px solid #a2a9b1;border-bottom-color:var(--indextable-hover-bg,#a2a9b1)}
.dfn-panel *{margin:0}
.dfn-panel b{display:block;color:#000;color:var(--text,#000);margin-top:.25em}
.dfn-panel ul a[href]{color:#333;color:var(--text,#333)}
.dfn-panel>div{display:flex}
.dfn-panel a.self-link{font-weight:700;margin-right:auto}
.dfn-panel .marker{padding:.1em;margin-left:.5em;border-radius:.2em;text-align:center;white-space:nowrap;font-size:90%;color:#040b1c}
.dfn-panel .marker.dfn-exported{background:#d1edfd;box-shadow:0 0 0 .125em #1ca5f940}
.dfn-panel .marker.idl-block{background:#8ccbf2;box-shadow:0 0 0 .125em #0670b161}
.dfn-panel a:not(:hover){text-decoration:none!important;border-bottom:none!important}
.dfn-panel a[href]:hover{border-bottom-width:1px}
.dfn-panel ul{padding:0}
.dfn-panel li{margin-left:1em}
.dfn-panel.docked{position:fixed;left:.5em;top:unset;bottom:2em;margin:0 auto;max-width:calc(100vw - .75em * 2 - .5em - .2em * 2);max-height:30vh;overflow:auto}
</style>
    
    
    
<title>FSC - Core 1.0.0</title>
    
    
    
    
<title>Default</title>
    
<link rel="shortcut icon" type="image/x-icon" href="https://gitdocumentatie.logius.nl/publicatie/respec/style/logos/logius.ico">
    
  
<style id="respec-mainstyle">
@keyframes pop{
0%{transform:scale(1,1)}
25%{transform:scale(1.25,1.25);opacity:.75}
100%{transform:scale(1,1)}
}
a.internalDFN{color:inherit;border-bottom:1px solid #99c;text-decoration:none}
a.externalDFN{color:inherit;border-bottom:1px dotted #ccc;text-decoration:none}
a.bibref{text-decoration:none}
.respec-offending-element:target{animation:pop .25s ease-in-out 0s 1}
.respec-offending-element,a[href].respec-offending-element{text-decoration:red wavy underline}
@supports not (text-decoration:red wavy underline){
.respec-offending-element:not(pre){display:inline-block}
.respec-offending-element{background:url(data:image/gif;base64,R0lGODdhBAADAPEAANv///8AAP///wAAACwAAAAABAADAEACBZQjmIAFADs=) bottom repeat-x}
}
#references :target{background:#eaf3ff;animation:pop .4s ease-in-out 0s 1}
cite .bibref{font-style:normal}
a[href].orcid{padding-left:4px;padding-right:4px}
a[href].orcid>svg{margin-bottom:-2px}
ol.tof,ul.tof{list-style:none outside none}
.caption{margin-top:.5em;font-style:italic}
#issue-summary>ul{column-count:2}
#issue-summary li{list-style:none;display:inline-block}
details.respec-tests-details{margin-left:1em;display:inline-block;vertical-align:top}
details.respec-tests-details>*{padding-right:2em}
details.respec-tests-details[open]{z-index:999999;position:absolute;border:thin solid #cad3e2;border-radius:.3em;background-color:#fff;padding-bottom:.5em}
details.respec-tests-details[open]>summary{border-bottom:thin solid #cad3e2;padding-left:1em;margin-bottom:1em;line-height:2em}
details.respec-tests-details>ul{width:100%;margin-top:-.3em}
details.respec-tests-details>li{padding-left:1em}
.self-link:hover{opacity:1;text-decoration:none;background-color:transparent}
aside.example .marker>a.self-link{color:inherit}
.header-wrapper{display:flex;align-items:baseline;position:relative;left:-.5em}
:is(h2,h3,h4,h5,h6):not(#toch2)+a.self-link{color:inherit;order:-1;position:relative;left:-.7em;font-size:1rem;opacity:.5}
:is(h2,h3,h4,h5,h6)+a.self-link::before{content:"§";text-decoration:none;color:var(--heading-text)}
:is(h2,h3)+a.self-link{top:-.2em}
:is(h4,h5,h6)+a.self-link::before{color:#000}
@media (max-width:767px){
dd{margin-left:0}
}
@media print{
.removeOnSave{display:none}
}
</style>
<style id="respec-nlgov">
img.license{float:left;padding-right:5px}
</style>
<meta name="description" content="This Federated Service Connectivity (FSC) standard describes how different parties (within FSC know as Peers) should interact when exchanging data in a uniform, secure and automated manner.
The goal of FSC is to achieve technically interoperable API gateway functionality, covering federated authentication and secure connections in a large-scale dynamic API landscape.">
<style>
.hljs{--base:#fafafa;--mono-1:#383a42;--mono-2:#686b77;--mono-3:#717277;--hue-1:#0b76c5;--hue-2:#336ae3;--hue-3:#a626a4;--hue-4:#42803c;--hue-5:#ca4706;--hue-5-2:#c91243;--hue-6:#986801;--hue-6-2:#9a6a01}
@media (prefers-color-scheme:dark){
.hljs{--base:#282c34;--mono-1:#abb2bf;--mono-2:#818896;--mono-3:#5c6370;--hue-1:#56b6c2;--hue-2:#61aeee;--hue-3:#c678dd;--hue-4:#98c379;--hue-5:#e06c75;--hue-5-2:#be5046;--hue-6:#d19a66;--hue-6-2:#e6c07b}
}
.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;color:var(--mono-1,#383a42);background:#fafafa;background:var(--base,#fafafa)}
.hljs-comment,.hljs-quote{color:#717277;color:var(--mono-3,#717277);font-style:italic}
.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4;color:var(--hue-3,#a626a4)}
.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#ca4706;color:var(--hue-5,#ca4706);font-weight:700}
.hljs-literal{color:#0b76c5;color:var(--hue-1,#0b76c5)}
.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#42803c;color:var(--hue-4,#42803c)}
.hljs-built_in,.hljs-class .hljs-title{color:#9a6a01;color:var(--hue-6-2,#9a6a01)}
.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801;color:var(--hue-6,#986801)}
.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#336ae3;color:var(--hue-2,#336ae3)}
.hljs-emphasis{font-style:italic}
.hljs-strong{font-weight:700}
.hljs-link{text-decoration:underline}
</style>
<style>

  .sidelabel {
    position: fixed;
    -webkit-transform-origin: top right;
    right: 100%;
    top: 0;
    -webkit-transform: rotate(-90deg);
    padding: 4px 50px 4px 10px;
    color: white;
    white-space: nowrap;
    z-index: 1;
    background-color: #154273;
  }
</style>
<script id="initialUserConfig" type="application/json">{
  "nl_organisationName": "Vereniging van Nederlandse Gemeenten",
  "nl_organisationStylesURL": "https://gitdocumentatie.logius.nl/publicatie/respec/style/",
  "nl_organisationPublishURL": "https://gitdocumentatie.logius.nl/publicatie/",
  "logos": [
    {
      "src": "https://vng.nl/themes/custom/vng/logo.svg",
      "alt": "VNG",
      "id": "VNG",
      "height": 77,
      "width": 44,
      "url": "https://vng.nl/rubrieken/onderwerpen/standaarden"
    }
  ],
  "useLogo": true,
  "useLabel": true,
  "latestVersion": [
    "nl_organisationPublishURL"
  ],
  "thisVersion": [
    "nl_organisationPublishURL"
  ],
  "prevVersion": [
    "nl_organisationPublishURL"
  ],
  "license": "cc-by",
  "addSectionLinks": true,
  "localizationStrings": {
    "en": {
      "wv": "Draft",
      "cv": "Recommendation",
      "vv": "Proposed recommendation",
      "def": "Definitive version",
      "basis": "Document",
      "eo": "Outdated version",
      "tg": "Rescinded version",
      "no": "Norm",
      "st": "Standard",
      "im": "Information model",
      "pr": "Guideline",
      "hr": "Guide",
      "wa": "Proposed recommendation",
      "al": "General",
      "bd": "Governance documentation",
      "bp": "Best practice"
    },
    "nl": {
      "wv": "Werkversie",
      "cv": "Consultatieversie",
      "vv": "Versie ter vaststelling",
      "def": "Vastgestelde versie",
      "basis": "Document",
      "eo": "Verouderde versie",
      "tg": "Teruggetrokken versie",
      "no": "Norm",
      "st": "Standaard",
      "im": "Informatiemodel",
      "pr": "Praktijkrichtlijn",
      "hr": "Handreiking",
      "wa": "Werkafspraak",
      "al": "Algemeen",
      "bd": "Beheerdocumentatie",
      "bp": "Best practice"
    }
  },
  "sotdText": {
    "nl": {
      "sotd": "Status van dit document",
      "def": "Dit is de definitieve versie van dit document. Wijzigingen naar aanleiding van consultaties zijn doorgevoerd.",
      "wv": "Dit is een werkversie die op elk moment kan worden gewijzigd, verwijderd of vervangen door andere documenten. Het is geen door het TO goedgekeurde consultatieversie.",
      "cv": "Dit is een door het TO goedgekeurde consultatieversie. Commentaar over dit document kan gestuurd worden naar ",
      "vv": "Dit is een definitief concept van de nieuwe versie van dit document. Wijzigingen naar aanleiding van consultaties zijn doorgevoerd.",
      "basis": "Dit is een document zonder officiële status."
    },
    "en": {
      "sotd": "Status of This Document",
      "def": "This is the definitive version of this document. Edits resulting from consultations have been applied.",
      "wv": "This is a draft that could be altered, removed or replaced by other documents. It is not a recommendation approved by TO.",
      "cv": "This is a proposed recommendation approved by TO. Comments regarding this document may be sent to ",
      "vv": "This is the definitive concept of this document. Edits resulting from consultations have been applied.",
      "basis": "This document has no official standing."
    }
  },
  "labelColor": {
    "def": "#154273",
    "wv": "#39870c"
  },
  "licenses": {
    "cc0": {
      "name": "Creative Commons 0 Public Domain Dedication",
      "short": "CC0",
      "url": "https://creativecommons.org/publicdomain/zero/1.0/",
      "image": "https://gitdocumentatie.logius.nl/publicatie/respec/media/logos/cc-zero.svg"
    },
    "cc-by": {
      "name": "Creative Commons Attribution 4.0 International Public License",
      "short": "CC-BY",
      "url": "https://creativecommons.org/licenses/by/4.0/legalcode",
      "image": "https://gitdocumentatie.logius.nl/publicatie/respec/media/logos/cc-by.svg"
    },
    "cc-by-nd": {
      "name": "Creative Commons Naamsvermelding-GeenAfgeleideWerken 4.0 Internationaal",
      "short": "CC-BY-ND",
      "url": "https://creativecommons.org/licenses/by-nd/4.0/legalcode.nl",
      "image": "https://gitdocumentatie.logius.nl/publicatie/respec/media/logos/cc-by-nd.svg"
    }
  },
  "localBiblio": {
    "SemVer": {
      "href": "https://semver.org",
      "title": "Semantic Versioning 2.0.0",
      "authors": [
        "T. Preston-Werner"
      ],
      "date": "June 2013"
    }
  },
  "specStatus": "DEF",
  "specType": "ST",
  "pubDomain": "fsc",
  "shortName": "core",
  "publishDate": "2024-12-12",
  "publishVersion": "1.0.0",
  "previousMaturity": "DEF",
  "editors": [
    {
      "name": "VNG Realisatie",
      "company": "VNG",
      "companyURL": "https://vng.nl/rubrieken/onderwerpen/standaarden"
    }
  ],
  "authors": [
    {
      "name": "Eelco Hotting",
      "company": "Hotting IT",
      "extras": [
        {
          "name": "Email",
          "href": "mailto:rfc@hotting.it"
        }
      ]
    },
    {
      "name": "Ronald Koster",
      "company": "PhillyShell",
      "extras": [
        {
          "name": "Email",
          "href": "mailto:rfc@phillyshell.nl"
        }
      ]
    },
    {
      "name": "Henk van Maanen",
      "company": "AceWorks",
      "extras": [
        {
          "name": "Email",
          "href": "mailto:henk.van.maanen@aceworks.nl"
        }
      ]
    },
    {
      "name": "Niels Dequeker",
      "company": "ND Software",
      "extras": [
        {
          "name": "Email",
          "href": "mailto:niels@nd-software.be"
        }
      ]
    },
    {
      "name": "Edward van Gelderen",
      "company": "vanG IT",
      "extras": [
        {
          "name": "Email",
          "href": "mailto:e.van.gelderen@vang.nl"
        }
      ]
    },
    {
      "name": "Pim Gaemers",
      "company": "Apily",
      "extras": [
        {
          "name": "Email",
          "href": "mailto:pim.gaemers@apily.dev"
        }
      ]
    }
  ],
  "github": "https://github.com/Logius-standaarden/fsc-core"
}</script>
<link rel="stylesheet" href="https://gitdocumentatie.logius.nl/publicatie/respec/style/base.css"></head>
  <body class="h-entry toc-inline"><div class="head">
    <a class="logo" href="https://vng.nl/rubrieken/onderwerpen/standaarden"><img alt="VNG" height="77" id="VNG" src="https://vng.nl/themes/custom/vng/logo.svg" width="44">
  </a> <h1 id="title" class="title">FSC - Core 1.0.0</h1>
    
    <h2>
      Vereniging van Nederlandse Gemeenten Standard<br>
      Definitive version
      <time class="dt-published" datetime="2024-12-12">December 12, 2024</time>
    </h2>
    <dl>
      <dt>This version:</dt><dd class="status">
              <a class="u-url status" href="https://gitdocumentatie.logius.nl/publicatie/">https://gitdocumentatie.logius.nl/publicatie/</a>
            </dd>
      <dt>Latest published version:</dt><dd>
              <a href="https://gitdocumentatie.logius.nl/publicatie/">https://gitdocumentatie.logius.nl/publicatie/</a>
            </dd>
      <dt>Latest editor's draft:</dt><dd><a href="https://logius-standaarden.github.io/fsc-core/">https://logius-standaarden.github.io/fsc-core/</a></dd>
      
      
      
      <dt>Previous version:</dt><dd><a href="https://gitdocumentatie.logius.nl/publicatie/">https://gitdocumentatie.logius.nl/publicatie/</a></dd>
      
      <dt>Editor:</dt>
      <dd class="editor p-author h-card vcard">
    <span class="p-name fn">VNG Realisatie</span> (<a class="p-org org h-org" href="https://vng.nl/rubrieken/onderwerpen/standaarden">VNG</a>)
  </dd>
      
      <dt>Authors:</dt><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Eelco Hotting</span> (<span class="p-org org h-org">Hotting IT</span>), <a href="mailto:rfc@hotting.it">Email</a>
  </dd><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Ronald Koster</span> (<span class="p-org org h-org">PhillyShell</span>), <a href="mailto:rfc@phillyshell.nl">Email</a>
  </dd><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Henk van Maanen</span> (<span class="p-org org h-org">AceWorks</span>), <a href="mailto:henk.van.maanen@aceworks.nl">Email</a>
  </dd><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Niels Dequeker</span> (<span class="p-org org h-org">ND Software</span>), <a href="mailto:niels@nd-software.be">Email</a>
  </dd><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Edward van Gelderen</span> (<span class="p-org org h-org">vanG IT</span>), <a href="mailto:e.van.gelderen@vang.nl">Email</a>
  </dd><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Pim Gaemers</span> (<span class="p-org org h-org">Apily</span>), <a href="mailto:pim.gaemers@apily.dev">Email</a>
  </dd>
      <dt>Participate:</dt><dd>
    <a href="https://github.com/Logius-standaarden/fsc-core/">GitHub Logius-standaarden/fsc-core</a>
  </dd><dd>
    <a href="https://github.com/Logius-standaarden/fsc-core/issues/">File an issue</a>
  </dd><dd>
    <a href="https://github.com/Logius-standaarden/fsc-core/commits/">Commit history</a>
  </dd><dd>
    <a href="https://github.com/Logius-standaarden/fsc-core/pulls/">Pull requests</a>
  </dd>
    </dl>
    
    
    
    <p class="copyright">
          This document is licensed under 
          <a rel="license" href="https://creativecommons.org/licenses/by/4.0/legalcode" class="subfoot"><img class="license" src="https://gitdocumentatie.logius.nl/publicatie/respec/media/logos/cc-by.svg" alt="Logo Creative Commons Attribution 4.0 International Public License"><br> Creative Commons Attribution 4.0 International Public License</a>
        </p>
    <hr title="Separator for header">
  </div>
    <section id="abstract" class="introductory"><h2>Abstract</h2><p>This Federated Service Connectivity (FSC) standard describes how different parties (within FSC know as Peers) should interact when exchanging data in a uniform, secure and automated manner.
The goal of FSC is to achieve technically interoperable API gateway functionality, covering federated authentication and secure connections in a large-scale dynamic API landscape.</p>
<p>The core of FSC is to manage (service) connections between FSC Peers via mutually agreed and signed contracts. These contracts are the technical prerequisite for connecting to services. 
Contracts are negotiated, and signed in a decentralized federated manner. </p>
<p>In addition to service connectivity, FSC provides a scheme for service discovery using a centralized directory. Peers providing services can voluntarily publish (some of) their services into this directory.
Peers consuming services can find the required location information for initiating contract negotiation for a particular service in this directory.</p>
<p>Security is at the foreground in FSC. Peers collaborating via FSC need to collaborate with each other in a FSC Group. The FSC Group is used for establishing trust between peers using a Public Key Infrastructure (PKI) scheme.
Technically FSC leverages PKI based on x.509 architecture to establish trust between Peers. Participating Peers agree on a Root CA acting as Trust Anchor. All connections between Peers leverage mTLS and contracts are cryptographically signed.
This combination ensures strong confidentiality and integrity.</p>
</section>
    <section id="sotd" class="introductory"><h2>Status of This Document</h2><p>This is the definitive version of this document. Edits resulting from consultations have been applied.</p></section><nav id="toc"><h2 class="introductory" id="table-of-contents">Table of Contents</h2><ol class="toc"><li class="tocline"><a class="tocxref" href="#abstract">Abstract</a></li><li class="tocline"><a class="tocxref" href="#sotd">Status of This Document</a></li><li class="tocline"><a class="tocxref" href="#introduction"><bdi class="secno">1. </bdi>Introduction</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#purpose"><bdi class="secno">1.1 </bdi>Purpose</a></li><li class="tocline"><a class="tocxref" href="#terminology"><bdi class="secno">1.2 </bdi>Terminology</a></li><li class="tocline"><a class="tocxref" href="#overall-operation-of-fsc-core"><bdi class="secno">1.3 </bdi>Overall Operation of FSC Core</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#extensions"><bdi class="secno">1.3.1 </bdi>Extensions</a></li><li class="tocline"><a class="tocxref" href="#profiles"><bdi class="secno">1.3.2 </bdi>Profiles</a></li><li class="tocline"><a class="tocxref" href="#use-cases"><bdi class="secno">1.3.3 </bdi>Use cases</a></li></ol></li></ol></li><li class="tocline"><a class="tocxref" href="#architecture"><bdi class="secno">2. </bdi>Architecture</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#trustanchor"><bdi class="secno">2.1 </bdi>Identity and Trust </a></li><li class="tocline"><a class="tocxref" href="#contract-management"><bdi class="secno">2.2 </bdi>Contract Management</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#contract-states"><bdi class="secno">2.2.1 </bdi>Contract states</a></li></ol></li><li class="tocline"><a class="tocxref" href="#creating-a-group"><bdi class="secno">2.3 </bdi>Creating a Group</a></li><li class="tocline"><a class="tocxref" href="#service-discovery"><bdi class="secno">2.4 </bdi>Service discovery</a></li><li class="tocline"><a class="tocxref" href="#create-an-authorization-to-connect-to-a-service"><bdi class="secno">2.5 </bdi>Create an authorization to connect to a Service</a></li><li class="tocline"><a class="tocxref" href="#delegate-the-authorization-to-connect-to-a-service"><bdi class="secno">2.6 </bdi>Delegate the authorization to connect to a Service</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#a-delegated-service-connection"><bdi class="secno">2.6.1 </bdi>A delegated service connection</a></li><li class="tocline"><a class="tocxref" href="#combining-a-delegated-service-publication-with-a-delegated-service-connection"><bdi class="secno">2.6.2 </bdi>Combining a delegated service publication with a delegated service connection</a></li></ol></li><li class="tocline"><a class="tocxref" href="#consuming-a-service"><bdi class="secno">2.7 </bdi>Consuming a Service</a></li><li class="tocline"><a class="tocxref" href="#use-cases-and-required-components"><bdi class="secno">2.8 </bdi>Use cases and required components</a></li></ol></li><li class="tocline"><a class="tocxref" href="#specifications"><bdi class="secno">3. </bdi>Specifications</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#protocols"><bdi class="secno">3.1 </bdi>Protocols</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#port-configuration"><bdi class="secno">3.1.1 </bdi>Port configuration</a></li><li class="tocline"><a class="tocxref" href="#group_id"><bdi class="secno">3.1.2 </bdi>Group ID</a></li><li class="tocline"><a class="tocxref" href="#peer_id"><bdi class="secno">3.1.3 </bdi>Peer ID</a></li><li class="tocline"><a class="tocxref" href="#peer_name"><bdi class="secno">3.1.4 </bdi>Peer name</a></li><li class="tocline"><a class="tocxref" href="#trust_anchor"><bdi class="secno">3.1.5 </bdi>Trust Anchor</a></li><li class="tocline"><a class="tocxref" href="#tls_configuration"><bdi class="secno">3.1.6 </bdi>TLS configuration</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#tls-version"><bdi class="secno">3.1.6.1 </bdi>TLS Version</a></li><li class="tocline"><a class="tocxref" href="#certificate_thumbprints"><bdi class="secno">3.1.6.2 </bdi>Certificate &amp; Public key thumbprints</a></li></ol></li><li class="tocline"><a class="tocxref" href="#error_handling"><bdi class="secno">3.1.7 </bdi>Error Handling</a></li></ol></li><li class="tocline"><a class="tocxref" href="#contracts"><bdi class="secno">3.2 </bdi>Contracts</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#contract_validation"><bdi class="secno">3.2.1 </bdi>Contract Validation</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#service_publication_grant"><bdi class="secno">3.2.1.1 </bdi>ServicePublicationGrant</a></li><li class="tocline"><a class="tocxref" href="#grant_delegated_service_publication"><bdi class="secno">3.2.1.2 </bdi>DelegatedServicePublicationGrant </a></li><li class="tocline"><a class="tocxref" href="#service_connection_grant"><bdi class="secno">3.2.1.3 </bdi>ServiceConnectionGrant</a></li><li class="tocline"><a class="tocxref" href="#grant_delegated_service_connection"><bdi class="secno">3.2.1.4 </bdi>DelegatedServiceConnectionGrant</a></li></ol></li><li class="tocline"><a class="tocxref" href="#signatures"><bdi class="secno">3.2.2 </bdi>Signatures</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#payload-fields"><bdi class="secno">3.2.2.1 </bdi>Payload fields</a></li><li class="tocline"><a class="tocxref" href="#signature_types"><bdi class="secno">3.2.2.2 </bdi>Signature types</a></li></ol></li><li class="tocline"><a class="tocxref" href="#content_hash"><bdi class="secno">3.2.3 </bdi>The content hash</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#data_types"><bdi class="secno">3.2.3.1 </bdi>Data types</a></li></ol></li><li class="tocline"><a class="tocxref" href="#grant_hash"><bdi class="secno">3.2.4 </bdi>Grant hash</a></li><li class="tocline"><a class="tocxref" href="#type-mappings"><bdi class="secno">3.2.5 </bdi>Type mappings</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#type_mapping_hash"><bdi class="secno">3.2.5.1 </bdi>Hash types</a></li><li class="tocline"><a class="tocxref" href="#type_mapping_grant"><bdi class="secno">3.2.5.2 </bdi>Grant types</a></li><li class="tocline"><a class="tocxref" href="#type_mapping_hash_algorithm"><bdi class="secno">3.2.5.3 </bdi>Hash algorithms</a></li><li class="tocline"><a class="tocxref" href="#type_mapping_service"><bdi class="secno">3.2.5.4 </bdi>Service types</a></li></ol></li></ol></li><li class="tocline"><a class="tocxref" href="#access_token"><bdi class="secno">3.3 </bdi>Access token</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#jwt-payload"><bdi class="secno">3.3.1 </bdi>JWT Payload</a></li></ol></li><li class="tocline"><a class="tocxref" href="#manager"><bdi class="secno">3.4 </bdi>Manager</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#behavior"><bdi class="secno">3.4.1 </bdi>Behavior</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#authentication"><bdi class="secno">3.4.1.1 </bdi>Authentication</a></li><li class="tocline"><a class="tocxref" href="#contracts-0"><bdi class="secno">3.4.1.2 </bdi>Contracts</a></li><li class="tocline"><a class="tocxref" href="#signatures-1"><bdi class="secno">3.4.1.3 </bdi>Signatures</a></li><li class="tocline"><a class="tocxref" href="#providing-x-509-certificates"><bdi class="secno">3.4.1.4 </bdi>Providing X.509 certificates</a></li><li class="tocline"><a class="tocxref" href="#providing-contracts"><bdi class="secno">3.4.1.5 </bdi>Providing contracts</a></li><li class="tocline"><a class="tocxref" href="#manager_tokens"><bdi class="secno">3.4.1.6 </bdi>Tokens</a></li><li class="tocline"><a class="tocxref" href="#services"><bdi class="secno">3.4.1.7 </bdi>Services</a></li><li class="tocline"><a class="tocxref" href="#service-listing"><bdi class="secno">3.4.1.8 </bdi>Service listing</a></li><li class="tocline"><a class="tocxref" href="#peer-listing"><bdi class="secno">3.4.1.9 </bdi>Peer listing</a></li></ol></li><li class="tocline"><a class="tocxref" href="#announce"><bdi class="secno">3.4.2 </bdi>Announce</a></li><li class="tocline"><a class="tocxref" href="#manager_interface"><bdi class="secno">3.4.3 </bdi>Interfaces</a></li><li class="tocline"><a class="tocxref" href="#fsc-manager-address"><bdi class="secno">3.4.4 </bdi>FSC manager address</a></li><li class="tocline"><a class="tocxref" href="#error-response"><bdi class="secno">3.4.5 </bdi>Error response</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#oauth-2-0-error-response"><bdi class="secno">3.4.5.1 </bdi>OAuth 2.0 error response</a></li><li class="tocline"><a class="tocxref" href="#other-endpoints"><bdi class="secno">3.4.5.2 </bdi>Other endpoints</a></li><li class="tocline"><a class="tocxref" href="#codes"><bdi class="secno">3.4.5.3 </bdi>Codes</a></li></ol></li></ol></li><li class="tocline"><a class="tocxref" href="#directory"><bdi class="secno">3.5 </bdi>Directory</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#behavior-0"><bdi class="secno">3.5.1 </bdi>Behavior</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#service-publication"><bdi class="secno">3.5.1.1 </bdi>Service publication</a></li></ol></li></ol></li><li class="tocline"><a class="tocxref" href="#outway"><bdi class="secno">3.6 </bdi>Outway</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#behavior-1"><bdi class="secno">3.6.1 </bdi>Behavior</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#authentication-0"><bdi class="secno">3.6.1.1 </bdi>Authentication</a></li><li class="tocline"><a class="tocxref" href="#routing"><bdi class="secno">3.6.1.2 </bdi>Routing</a></li><li class="tocline"><a class="tocxref" href="#obtaining-access-tokens"><bdi class="secno">3.6.1.3 </bdi>Obtaining access tokens</a></li><li class="tocline"><a class="tocxref" href="#error-response-0"><bdi class="secno">3.6.1.4 </bdi>Error response</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#codes-0"><bdi class="secno">3.6.1.4.1 </bdi>Codes</a></li></ol></li></ol></li></ol></li><li class="tocline"><a class="tocxref" href="#inway"><bdi class="secno">3.7 </bdi>Inway</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#behavior-2"><bdi class="secno">3.7.1 </bdi>Behavior</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#authentication-1"><bdi class="secno">3.7.1.1 </bdi>Authentication</a></li><li class="tocline"><a class="tocxref" href="#authorization"><bdi class="secno">3.7.1.2 </bdi>Authorization</a></li><li class="tocline"><a class="tocxref" href="#routing-0"><bdi class="secno">3.7.1.3 </bdi>Routing</a></li></ol></li><li class="tocline"><a class="tocxref" href="#interfaces-0"><bdi class="secno">3.7.2 </bdi>Interfaces</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#proxy-endpoint"><bdi class="secno">3.7.2.1 </bdi>Proxy Endpoint</a></li><li class="tocline"><a class="tocxref" href="#error-response-1"><bdi class="secno">3.7.2.2 </bdi>Error response</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#codes-1"><bdi class="secno">3.7.2.2.1 </bdi>Codes</a></li></ol></li></ol></li></ol></li><li class="tocline"><a class="tocxref" href="#references-0"><bdi class="secno">3.8 </bdi>References</a></li></ol></li><li class="tocline"><a class="tocxref" href="#conformance"><bdi class="secno">4. </bdi>Conformance</a></li><li class="tocline"><a class="tocxref" href="#tof"><bdi class="secno">5. </bdi>List of Figures</a></li><li class="tocline"><a class="tocxref" href="#references"><bdi class="secno">A. </bdi>References</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#normative-references"><bdi class="secno">A.1 </bdi>Normative references</a></li></ol></li></ol></nav>
    
    <section id="introduction"><div class="header-wrapper"><h2 id="x1-introduction"><bdi class="secno">1. </bdi>Introduction</h2><a class="self-link" href="#introduction" aria-label="Permalink for Section 1."></a></div>
<p>This section gives an introduction to FSC.
Section 2 describes the architecture of a system that follows the FSC specification.
Section 3 describes the interfaces and behavior of FSC components in detail.</p>
<section id="purpose"><div class="header-wrapper"><h3 id="x1-1-purpose"><bdi class="secno">1.1 </bdi>Purpose</h3><a class="self-link" href="#purpose" aria-label="Permalink for Section 1.1"></a></div>
<p>The Federated Service Connectivity (FSC) specifications describe a way to implement technically interoperable API gateway functionality, covering federated authentication and secure connecting in a large-scale dynamic API landscape. </p>
<p>The Core part of the FSC specification achieves inter-organizational, technical interoperability:</p>
<ul>
<li>to discover Services.</li>
<li>to route requests to Services in other contexts (e.g. from within organization A to organization B).</li>
<li>to request and manage authorizations needed to connect to said Services.</li>
<li>to delegate the authorization to connect or publish Services on behalf of another organization</li>
</ul>
<p>Functionality required to achieve technical interoperability is provided by APIs as specified in this RFC. This allows for automation of most management tasks, greatly reducing the administrative load and enabling up-scaling of inter-organizational usage of services.</p>
</section><section id="terminology"><div class="header-wrapper"><h3 id="x1-2-terminology"><bdi class="secno">1.2 </bdi>Terminology</h3><a class="self-link" href="#terminology" aria-label="Permalink for Section 1.2"></a></div>
<p>This specification lists terms and abbreviations as used in this document.</p>
<p><em>Peer:</em></p>
<p>Actor that provides and/or consumes Services. This is an abstraction of e.g. an organization, a department or a security context.</p>
<p><em>Group:</em></p>
<p>System of Peers using Inways, Outways and Managers that confirm to the FSC specification to make use of each other's Services.</p>
<p><em>Inway:</em></p>
<p>Reverse proxy that handles incoming connections to one or more Services.</p>
<p><em>Outway:</em></p>
<p>Forward proxy that handles outgoing connections to Inways.</p>
<p><em>Contract:</em></p>
<p>Agreement between Peers defining what interactions between Peers are possible.</p>
<p><em>Delegator:</em></p>
<p>A Peer who delegates a connection authorization to a Service or the authorization to publish a Service to another Peer.</p>
<p><em>Delegatee:</em></p>
<p>A Peer who acts on behalf of another Peer.</p>
<p><em>Grant:</em></p>
<p>Defines an interaction between Peers. Grants are part of a Contract. In FSC Core four Grants are described.</p>
<ol>
<li>The ServicePublicationGrant which specifies the authorization of a Peer to publish a Service in the Group.</li>
<li>The ServiceConnectionGrant which specifies the authorization of a Peer to connect to a Service provided by a Peer.</li>
<li>The DelegatedServicePublicationGrant which specifies the authorization of one peer to publish a Service to the Group on behalf of another Peer.</li>
<li>The DelegatedServiceConnectionGrant which specifies the authorization of one Peer to connect to a Service on behalf of another Peer.</li>
</ol>
<p><em>Manager:</em></p>
<p>The Manager is an API which manages Contracts and acts as an authorization server which provides access tokens.</p>
<p><em>Directory:</em></p>
<p>A Manager which acts as a Service and Peer discovery point of the Group.</p>
<p><em>Service:</em></p>
<p>An HTTP API offered to the Group.</p>
<p><em>Trust Anchor:</em></p>
<p>The Trust Anchor (TA) is an authoritative entity for which trust is assumed and not derived. In the case of FSC, which uses an X.509 architecture, it is the root certificate from which the whole chain of trust is derived.</p>
<p><em>Profile:</em> </p>
<p>A set of rules providing further restrictions and governance of the FSC Group. A Profile aligns on certain required parameters needed for the practical workings of an FSC Group. </p>
</section><section id="overall-operation-of-fsc-core"><div class="header-wrapper"><h3 id="x1-3-overall-operation-of-fsc-core"><bdi class="secno">1.3 </bdi>Overall Operation of FSC Core</h3><a class="self-link" href="#overall-operation-of-fsc-core" aria-label="Permalink for Section 1.3"></a></div>
<p>Peers in a Group announce their HTTP APIs to the Group by publishing them as a Service to the Directory. A Group uses a single Directory that defines the scope of the Group. Peers use the Directory to discover what Services and Peers are available in the Group.
Inways of a Peer expose Services to the Group. 
Outways of a Peer connect to the Inway of a Peer providing a Service.
Contracts define the Service publication to the Group and connections between Peers.
Peers can delegate the authorization to connect a Service to other Peers using specific Grants on a Contract.
Peers can delegate the authorization to publish a Service to other Peers using specific Grants on a Contracts.</p>
<p>Outways are forward proxies that route outgoing connections to Inways.<br>Inways are reverse proxies that route incoming connections from Outways to Services.<br>Managers negotiate Contracts between Peers.<br>Managers provide access tokens which contain the authorization to connect a Service. 
Outways include the access tokens in requests to Inways
The address of an Inway offering a Service is contained in the access token. 
Inways authorize connection attempts by validating access tokens.
Services in the Group can be discovered through the Directory.<br>The Manager's address of a Peer can be discovered through the Directory. </p>
<p>To connect to a Service, the Peer needs a Contract with a ServiceConnectionGrant or DelegatedServiceConnectionGrant that specifies the connection. The FSC Core specification describes how Contracts are created, accepted, rejected and revoked. Once an authorization to connect is granted through a Contract, a connection from HTTP Client to HTTP Service will be authorized everytime an HTTP request to the Service is made.</p>
<section id="extensions"><div class="header-wrapper"><h4 id="x1-3-1-extensions"><bdi class="secno">1.3.1 </bdi>Extensions</h4><a class="self-link" href="#extensions" aria-label="Permalink for Section 1.3.1"></a></div>
<p>FSC Core specifies the basics for setting up and managing connections in a Group.
Auxiliary functionality for either an FSC Peer or an entire FSC Group can be realized with <code>extensions</code>. An Extension performs a well scoped feature enhancing the overall working of FSC. </p>
<p>It is <strong><em class="rfc2119">RECOMMENDED</em></strong> to use FSC Core with the following extensions, each specified in a dedicated RFC:</p>
<ul>
<li><a href="../logging/draft-fsc-logging-00.html">FSC Logging</a>, keep a log of requests to Services.</li>
</ul>
</section><section id="profiles"><div class="header-wrapper"><h4 id="x1-3-2-profiles"><bdi class="secno">1.3.2 </bdi>Profiles</h4><a class="self-link" href="#profiles" aria-label="Permalink for Section 1.3.2"></a></div>
<p>FSC Core provides the foundation for cooperation between organizations (Peers). However, in practice additional decisions have to be made to guarantee a functioning Group within a broader context.
For example, it may be needed for an Group to have additional restrictions or agreements within the Group. This set of agreements is called the <code>Profile</code>. Every Group <strong><em class="rfc2119">MUST</em></strong> have at least one Profile in order te operate.
A Group <strong><em class="rfc2119">MAY</em></strong> use multiple Profiles to further enhance the rules and restrictions within the Group. It is the responsibility of the Group to prevent conflicts between the Profiles used by the Group.</p>
<p>The following decisions <strong><em class="rfc2119">MUST</em></strong> be part of the Profile:</p>
<ol>
<li>Select a <a href="#trust_anchor">Trust Anchor</a></li>
<li>Select a <a href="#group_id">Group ID</a></li>
<li>Select what determines the <a href="#peer_id">Peer ID</a></li>
<li>Select what determines the <a href="#peer_name">Peer name</a></li>
<li>Select a Peer who acts as the <a href="#directory">Directory</a> of the Group</li>
<li>Decide what ports are used for management traffic</li>
<li>Determine requirements for allowed TLS versions and Cipher Suites</li>
</ol>
<p>In addition to the mandatory decisions, a Profile <strong><em class="rfc2119">MAY</em></strong> also contain additional agreements or restrictions. These are not technically required for the operation of FSC Core, but can become mandatory within a Group. An example would be a set of additional rules in order to comply with local legislation.
Below are a few examples listed of these additional decisions for inspirational purposes:</p>
<ol>
<li>Any extensions required by Peers within the Group</li>
<li>Agreements on data retention</li>
<li>The specifics of the retry mechanism used for Contract synchronization</li>
<li>Additional restrictions on Certificate revocation by mandating OCSP or CRL checks</li>
</ol>
</section><section id="use-cases"><div class="header-wrapper"><h4 id="x1-3-3-use-cases"><bdi class="secno">1.3.3 </bdi>Use cases</h4><a class="self-link" href="#use-cases" aria-label="Permalink for Section 1.3.3"></a></div>
<p>A typical use case is a cooperation of many organizations that use APIs to exchange data or provide other business services to each other.</p>
<p>Organizations can participate in multiple Groups at the same time. 
Reasons for participating in multiple Groups could be the use of different environments for production and test deployments or when participating in different ecosystems like health industry and government industry.</p>
<p>An organization can offer the same API in multiple Groups. When doing so, the organization will be a Peer in every Group, and define the API as a Service in the Directory of each Group using a different Inway for each Group.</p>
</section></section></section>
    <section id="architecture"><div class="header-wrapper"><h2 id="x2-architecture"><bdi class="secno">2. </bdi>Architecture</h2><a class="self-link" href="#architecture" aria-label="Permalink for Section 2."></a></div>
<p>This chapter describes the basic architecture of an FSC system.</p>
<section id="identity-and-trust"><div class="header-wrapper"><h3 id="trustanchor"><bdi class="secno">2.1 </bdi>Identity and Trust </h3><a class="self-link" href="#trustanchor" aria-label="Permalink for Section 2.1"></a></div><p>Connections between Managers, Inways, Outways use Mutual Transport Layer Security (mTLS) with X.509 certificates. 
Components in the Group are configured to accept the same (Sub-) Certificate Authorities (CA) as Trust Anchors (TA). Each TA is a Trusted Third Party that ensures the identity of the Peers by verifying a set of fields of the subject field , <a href="https://rfc-editor.org/rfc/rfc5280">section 4.1.2.6</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc5279" title="A Uniform Resource Name (URN) Namespace for the 3rd Generation Partnership Project (3GPP)">RFC5279</a></cite>] that act as <a href="#peer_id">PeerID</a> in each X.509 certificate.
When multiple TAs are used the TAs must ensure that the elements of the subject field used to identify a Peer are the same across the TAs. </p>
<p>
      </p><figure id="fig-mtls-connections">
        <img src="diagrams/seq-mtls-connections.svg" alt="mTLS Connections">
        <figcaption><a class="self-link" href="#fig-mtls-connections">Figure <bdi class="figno">1</bdi></a> <span class="fig-title">mTLS Connections</span></figcaption>
      </figure>
    <p></p>
</section><section id="contract-management"><div class="header-wrapper"><h3 id="x2-2-contract-management"><bdi class="secno">2.2 </bdi>Contract Management</h3><a class="self-link" href="#contract-management" aria-label="Permalink for Section 2.2"></a></div>
<p>Contracts are negotiated between the Managers of Peers. The Directory provides the address of each Manager.
Connections to Services are authorized by Contracts with ServiceConnectionGrants. To create a new contract, the Manager uses a selection of desired connections as input. (Typically this input comes from a user interface interacting with the Management functionality). For each desired connection, a ServiceConnectionGrant is formulated that contains identifying information about both the Outway from the Service consumer and the Service of the Service provider. One Contract may contain multiple Grants. Grants typically match the connections mentioned in a legal agreement like a Data Processing Agreement (DPA). Valid Contracts are used to configure Inways and Outways and enable the possibility to automatically create on demand connections between Peers, as defined in the Grants.
Contracts can contain multiple Peers. E.g. if a Peer wants a single Contract for an application, this Contract can contain all the connections required for that application.</p>
<p>
      </p><figure id="fig-contract-management">
        <img src="diagrams/seq-contract-management.svg" alt="Contract Management">
        <figcaption><a class="self-link" href="#fig-contract-management">Figure <bdi class="figno">2</bdi></a> <span class="fig-title">Contract Management</span></figcaption>
      </figure>
    <p></p>
<ol>
<li>The initiating Peer gets the address of the Manager from the Directory.</li>
<li>The Directory return the Manager address to the Peer.</li>
<li>The initiating Peer sends the Contract proposal with its accept signature to the receiving Peer.</li>
<li>The receiving Peer sends back its own accept signature to the initiating Peer.</li>
</ol>
<section id="contract-states"><div class="header-wrapper"><h4 id="x2-2-1-contract-states"><bdi class="secno">2.2.1 </bdi>Contract states</h4><a class="self-link" href="#contract-states" aria-label="Permalink for Section 2.2.1"></a></div>
<p>Any Peer can submit a Contract to other Peers. This Contract becomes valid when the Peers mentioned in the Contract accept the Contract by placing an accept signature. </p>
<p>A Contract becomes invalid when at least one Peer mentioned in the Contract revokes the Contract.</p>
<p>A Contract becomes invalid when at least one Peer mentioned in the Contract rejects the Contract.</p>
<p>A Contract becomes invalid when the validity period of the Contract expires.</p>
<p>Accepting, rejecting and revoking is done by adding a digital signature.</p>
<p>The content of a Contract is immutable. When the content of a Contract is subject to change, the Contract is invalidated and replaced by a new one.</p>
<p>
      </p><figure id="fig-state-contract">
        <img src="diagrams/state-contract.svg" alt="State Contract">
        <figcaption><a class="self-link" href="#fig-state-contract">Figure <bdi class="figno">3</bdi></a> <span class="fig-title">State Contract</span></figcaption>
      </figure>
    <p></p>
</section></section><section id="creating-a-group"><div class="header-wrapper"><h3 id="x2-3-creating-a-group"><bdi class="secno">2.3 </bdi>Creating a Group</h3><a class="self-link" href="#creating-a-group" aria-label="Permalink for Section 2.3"></a></div>
<p>A Group is a system of Peers using Inways, Outways and Managers that confirm to the FSC specification to make use of each other's Services. </p>
<p>In order to create a Group a <a href="#profiles">Profile</a> containing at least the mandatory decisions <strong><em class="rfc2119">MUST</em></strong> be created.</p>
<p>Additionally optional decisions <strong>COULD</strong> be added to the profile whilst creating an FSC Group providing additional restrictions placed on the FSC Group.</p>
</section><section id="service-discovery"><div class="header-wrapper"><h3 id="x2-4-service-discovery"><bdi class="secno">2.4 </bdi>Service discovery</h3><a class="self-link" href="#service-discovery" aria-label="Permalink for Section 2.4"></a></div>
<p>Every Group is defined by one Directory that contains the Services and Peers in the Group.
All Peers in the Group make themselves known to the Directory by having their Manager call the <a href="#Announce">Announce</a> endpoint of the Directory. 
This way the Directory contains a list of all Peers in the Group with their corresponding Manager address.</p>
<p>When publishing services, Managers register Services by offering Contracts with a <a href="#service_publication_grant">ServicePublicationGrant</a> or <a href="#delegated_service_publication_grant">DelegatedServicePublicationGrant</a> to the Directory.</p>
<p>Peers query the Directory to discover the Services available in the Group </p>
<p>
      </p><figure id="fig-providing-a-service">
        <img src="diagrams/seq-providing-a-service.svg" alt="Providing a Service">
        <figcaption><a class="self-link" href="#fig-providing-a-service">Figure <bdi class="figno">4</bdi></a> <span class="fig-title">Providing a Service</span></figcaption>
      </figure>
    <p></p>
<ol>
<li>The Peer creates a Contract with a Service Publication Grant which contains the details of the Service.</li>
<li>The Peer adds its own accept signature to the Contract. </li>
<li>The Peer sends the Contract and accept signature to the Directory.</li>
<li>The Directory adds its own accept signature.</li>
<li>The Directory sends the accept signature to the Peer.</li>
</ol>
</section><section id="create-an-authorization-to-connect-to-a-service"><div class="header-wrapper"><h3 id="x2-5-create-an-authorization-to-connect-to-a-service"><bdi class="secno">2.5 </bdi>Create an authorization to connect to a Service</h3><a class="self-link" href="#create-an-authorization-to-connect-to-a-service" aria-label="Permalink for Section 2.5"></a></div>
<p>A connection can be established if the Peer connecting to the Service has a valid Contract containing a <a href="#service_connection_grant">ServiceConnectionGrant</a> with the Peer providing the Service.
The connection Grants contains information about the Service and the public key of the Outway that is authorized to connect to the Service.</p>
<p>The Contract is distributed among the two Peers. Once the Contract is signed by all Peers, the Outway can connect to the Inway offering the Service.</p>
<p>
      </p><figure id="fig-connecting-to-a-service">
        <img src="diagrams/seq-create-an-authorization-to-connect.svg" alt="Create an authorization to connect">
        <figcaption><a class="self-link" href="#fig-connecting-to-a-service">Figure <bdi class="figno">5</bdi></a> <span class="fig-title">Connecting to a Service</span></figcaption>
      </figure>
    <p></p>
<ol>
<li>The Service consumer creates a Contract with a Service Connection Grant which contains the details of the Service.</li>
<li>The Service consumer adds an accept signature to the Contract.</li>
<li>The Service consumer sends the Contract and the accept signature to the Service Provider.</li>
<li>The Service provider adds its own accept signature.</li>
<li>The Service provider sends the accept signature to the Service consumer.</li>
</ol>
<p>When the Service is being offered on behalf of another Peer the Contract is distributed among three Peers. The Peer acting as Delegator in the Service publication will also receive the Contract.
Once the Contract is signed by all the Peers, the Outway can connect to the Inway offering the Service on behalf the Delegator. </p>
<p>
      </p><figure id="fig-connecting-to-a-service-that-is-offered-on-behalf-of-another-peer">
        <img src="diagrams/seq-create-an-authorization-to-connect-delegated-publication.svg" alt="Create an authorization to connect">
        <figcaption><a class="self-link" href="#fig-connecting-to-a-service-that-is-offered-on-behalf-of-another-peer">Figure <bdi class="figno">6</bdi></a> <span class="fig-title">Connecting to a Service that is offered on behalf of another Peer</span></figcaption>
      </figure>
    <p></p>
<ol>
<li>The Service consumer creates a Contract with a Service Connection Grant which contains the details of the Service.</li>
<li>The Service consumer adds an accept signature to the Contract.</li>
<li>The Service consumer sends the Contract and the accept signature to the Service provider.</li>
<li>The Service consumer sends the Contract and the accept signature to the Delegator of Service Publication.</li>
<li>The Service provider adds its own accept signature.</li>
<li>The Service provider sends the accept signature to the Service consumer.</li>
<li>The Service provider sends the accept signature to the Delegator.</li>
<li>The Delegator adds its own accept signature.</li>
<li>The Delegator sends the accept signature to the Service provider.</li>
<li>The Delegator sends the accept signature to the Service consumer.</li>
</ol>
</section><section id="delegate-the-authorization-to-connect-to-a-service"><div class="header-wrapper"><h3 id="x2-6-delegate-the-authorization-to-connect-to-a-service"><bdi class="secno">2.6 </bdi>Delegate the authorization to connect to a Service</h3><a class="self-link" href="#delegate-the-authorization-to-connect-to-a-service" aria-label="Permalink for Section 2.6"></a></div>
<section id="a-delegated-service-connection"><div class="header-wrapper"><h4 id="x2-6-1-a-delegated-service-connection"><bdi class="secno">2.6.1 </bdi>A delegated service connection</h4><a class="self-link" href="#a-delegated-service-connection" aria-label="Permalink for Section 2.6.1"></a></div>
<p>A connection on behalf of another Peer (delegation) can only be established if the Peer connecting to the Service has a valid Contract containing a <a href="#delegated_service_connection_grant">DelegatedServiceConnectionGrant</a> with the Peer providing the Service.
The connection Grants contains information about the Service, the public key of the Outway that is authorized to connect to the Service and the Peer acting as Delegator.</p>
<p>The Contract is distributed among the three Peers. Once the Contract is signed by all the Peers, the Outway of the Delegatee can connect to the Inway offering the Service on behalf the Delegator.</p>
<p>
      </p><figure id="fig-delegate-a-connection-to-a-service">
        <img src="diagrams/seq-delegate-connection.svg" alt="Delegate connection">
        <figcaption><a class="self-link" href="#fig-delegate-a-connection-to-a-service">Figure <bdi class="figno">7</bdi></a> <span class="fig-title">Delegate a connection to a Service</span></figcaption>
      </figure>
    <p></p>
<ol>
<li>The Delegator creates a Contract with a Delegated Service Connection Grant which contains the details of the Service and the Peer who will be acting as Delegatee (who will consume the Service).</li>
<li>The Delegator adds its own accept signature to the Contract.</li>
<li>The Delegator sends the Contract and accept signature to the Delegatee.</li>
<li>The Delegatee adds its own accept signature.</li>
<li>The Delegatee sends the accept signature to the Delegator.</li>
<li>The Delegatee sends the accept signature to the Service Provider.</li>
<li>The Delegator sends the Contract and accept signature to the Service Provider.</li>
<li>The Service Provider adds its own accept signature.</li>
<li>The Service Provider sends the accept signature to the Delegatee.</li>
<li>The Service Provider sends the accept signature to the Delegator.</li>
</ol>
</section><section id="combining-a-delegated-service-publication-with-a-delegated-service-connection"><div class="header-wrapper"><h4 id="x2-6-2-combining-a-delegated-service-publication-with-a-delegated-service-connection"><bdi class="secno">2.6.2 </bdi>Combining a delegated service publication with a delegated service connection</h4><a class="self-link" href="#combining-a-delegated-service-publication-with-a-delegated-service-connection" aria-label="Permalink for Section 2.6.2"></a></div>
<p>When the Service is being offered on behalf of another Peer the Contract is distributed among four Peers. The Peer acting as Delegator in the Service publication will also receive the Contract.
Once the Contract is signed by all the Peers, the Outway of the Delegatee can connect to the Inway offering the Service on behalf the Delegator.</p>
<p>
      </p><figure id="fig-delegate-a-connection-to-a-service-that-is-offered-on-behalf-of-another-peer">
        <img src="diagrams/seq-delegate-connection-delegated-publication.svg" alt="Delegate connection">
        <figcaption><a class="self-link" href="#fig-delegate-a-connection-to-a-service-that-is-offered-on-behalf-of-another-peer">Figure <bdi class="figno">8</bdi></a> <span class="fig-title">Delegate a connection to a Service that is offered on behalf of another Peer</span></figcaption>
      </figure>
    <p></p>
<ol>
<li>The Delegator creates a Contract with a Delegated Service Connection Grant which contains the details of the Service and the Peer who will be acting as Delegatee (who will consume the Service).</li>
<li>The Delegator adds its own accept signature to the Contract.</li>
<li>The Delegator sends the Contract and accept signature to the Delegatee.</li>
<li>The Delegator sends the Contract and accept signature to the Service provider.</li>
<li>The Delegator sends the Contract and accept signature to the Delegator of the Service publication.</li>
<li>The Delegatee adds its own accept signature.</li>
<li>The Delegatee sends the accept signature to the Delegator.</li>
<li>The Delegatee sends the accept signature to the Service provider.</li>
<li>The Delegatee sends the accept signature to the Delegator of the Service publication.</li>
<li>The Service provider adds its own accept signature.</li>
<li>The Service provider sends the accept signature to the Delegatee.</li>
<li>The Service provider sends the accept signature to the Delegator.</li>
<li>The Service provider sends the accept signature to the Delegator of the Service publication.</li>
<li>The Delegator of the Service publication adds its own accept signature.</li>
<li>The Delegator of the Service publication sends the accept signature to the Delegatee.</li>
<li>The Delegator of the Service publication sends the accept signature to the Delegator.</li>
<li>The Delegator of the Service publication sends the accept signature to the Service provider.</li>
</ol>
</section></section><section id="consuming-a-service"><div class="header-wrapper"><h3 id="x2-7-consuming-a-service"><bdi class="secno">2.7 </bdi>Consuming a Service</h3><a class="self-link" href="#consuming-a-service" aria-label="Permalink for Section 2.7"></a></div>
<p>A Peer can consume a Service by sending request for said Service to an Outway. 
The Peer obtains an access token from the Manager of the Peer providing the Service. 
The Outway proxies the request including the access token to the Inway.
The Inway will validate the access token and proxy the request to the Service.</p>
<p>
      </p><figure id="fig-consuming-a-service">
        <img src="diagrams/seq-consuming-a-service.svg" alt="Consuming a Service">
        <figcaption><a class="self-link" href="#fig-consuming-a-service">Figure <bdi class="figno">9</bdi></a> <span class="fig-title">Consuming a Service</span></figcaption>
      </figure>
    <p></p>
<ol>
<li>The client application sends a request to the Outway.</li>
<li>The Outway creates an connection with the Inway and proxies the request. In this diagram it is assumed that the Outway already has an access token. </li>
<li>The Inway validates the provided access token before proxying the request to the Service.</li>
<li>The Inway proxies the request to the Service.</li>
<li>The Service returns the response to the Inway.</li>
<li>The Inway returns the response to the Outway.</li>
<li>The Outway returns the response to the client.</li>
</ol>
</section><section id="use-cases-and-required-components"><div class="header-wrapper"><h3 id="x2-8-use-cases-and-required-components"><bdi class="secno">2.8 </bdi>Use cases and required components</h3><a class="self-link" href="#use-cases-and-required-components" aria-label="Permalink for Section 2.8"></a></div>
<p>Which components a Peer needs depends on the use case.</p>
<p>A Peer who wants to consume Services needs a Manager and an Outway.  </p>
<p>A Peer who wants to offer Services needs a Manager and an Inway.    </p>
<p>A Peer who wants to both consume and offer Services needs a Manager,an Outway and an Inway.</p>
</section></section>
    <section id="specifications"><div class="header-wrapper"><h2 id="x3-specifications"><bdi class="secno">3. </bdi>Specifications</h2><a class="self-link" href="#specifications" aria-label="Permalink for Section 3."></a></div>
<section id="protocols"><div class="header-wrapper"><h3 id="x3-1-protocols"><bdi class="secno">3.1 </bdi>Protocols</h3><a class="self-link" href="#protocols" aria-label="Permalink for Section 3.1"></a></div>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> support HTTP/1.1[<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc9112" title="HTTP/1.1">RFC9112</a></cite>].</p>
<p>The Manager <strong><em class="rfc2119">MAY</em></strong> support HTTP/2[<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc9113" title="HTTP/2">RFC9113</a></cite>]. </p>
<p>The protocol used between the Inway and Outway can be either HTTP/1.1[<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc9112" title="HTTP/1.1">RFC9112</a></cite>] or HTTP/2[<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc9113" title="HTTP/2">RFC9113</a></cite>]. The protocol is determined by the <code>protocol</code> field of a Service as specified in the object <code>.components/schemas/serviceListingService</code> of the <a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">OpenAPI Specification</a>.</p>
<section id="port-configuration"><div class="header-wrapper"><h4 id="x3-1-1-port-configuration"><bdi class="secno">3.1.1 </bdi>Port configuration</h4><a class="self-link" href="#port-configuration" aria-label="Permalink for Section 3.1.1"></a></div>
<p>In order to provide a predictable network configuration FSC limits the selection of network ports to be used by components. 
The ports used by FSC components <strong><em class="rfc2119">MUST</em></strong> be <code>443</code> or <code>8443</code>. </p>
<p>Port <code>443</code> is <strong><em class="rfc2119">RECOMMENDED</em></strong> for data traffic i.e. HTTP requests to a Service.<br>Port <code>8443</code> is <strong><em class="rfc2119">RECOMMENDED</em></strong> for management traffic i.e. submitting/signing Contracts.  </p>
<p>Data traffic: Inway, Outway<br>Management Traffic: Directory, Manager</p>
</section><section id="group-id"><div class="header-wrapper"><h4 id="group_id"><bdi class="secno">3.1.2 </bdi>Group ID</h4><a class="self-link" href="#group_id" aria-label="Permalink for Section 3.1.2"></a></div><p>The Group ID is the identifier of the Group. This identifier is chosen by the Group upon creation of the Group.<br>The Group ID <strong><em class="rfc2119">MUST</em></strong> match the following regular expression <code>^[a-zA-Z0-9./_-]{1,100}$</code></p>
</section><section id="peer-id"><div class="header-wrapper"><h4 id="peer_id"><bdi class="secno">3.1.3 </bdi>Peer ID</h4><a class="self-link" href="#peer_id" aria-label="Permalink for Section 3.1.3"></a></div><p>Each Peer <strong><em class="rfc2119">MUST</em></strong> have a unique identifier within the Group, this identifier is called the PeerID. The PeerID is determined by at least one element from the subject field <a href="https://rfc-editor.org/rfc/rfc5280">section 4.1.2.6</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc5280" title="Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile">RFC5280</a></cite>] of an X.509 certificate. Each Group <strong><em class="rfc2119">MUST</em></strong> define which element(s) of the subject field of the X.509 certificate act as PeerID.
The TA(s) issuing the certificates must ensure that PeerID is always the same for a Peer in each issued certificate for said Peer.    </p>
</section><section id="peer-name"><div class="header-wrapper"><h4 id="peer_name"><bdi class="secno">3.1.4 </bdi>Peer name</h4><a class="self-link" href="#peer_name" aria-label="Permalink for Section 3.1.4"></a></div><p>Each Peer <strong><em class="rfc2119">MUST</em></strong> have a human-readable name which can be used to identify a Peer. Unlike the PeerID the name does not have to be unique. The name of Peer is determined by an element in the subject field <a href="https://rfc-editor.org/rfc/rfc5280">section 4.1.2.6</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc5280" title="Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile">RFC5280</a></cite>] of an X.509 certificate. The Group <strong><em class="rfc2119">MUST</em></strong> define which element of the subject field is used.</p>
</section><section id="trust-anchor"><div class="header-wrapper"><h4 id="trust_anchor"><bdi class="secno">3.1.5 </bdi>Trust Anchor</h4><a class="self-link" href="#trust_anchor" aria-label="Permalink for Section 3.1.5"></a></div><p>The Trust Anchor (TA) is an authoritative entity for which trust is assumed and not derived. In the case of FSC, which uses an X.509 architecture, it is the root certificate from which the whole chain of trust is derived.</p>
<p>Each Group can have multiple TAs.</p>
<p>Every Peer in a Group <strong><em class="rfc2119">MUST</em></strong> accept the same TA(s).</p>
<p>The TA <strong><em class="rfc2119">SHOULD</em></strong> validate a Peers identity, i.e. the TA <strong><em class="rfc2119">MUST</em></strong> preform Organization Validation.</p>
</section><section id="tls-configuration"><div class="header-wrapper"><h4 id="tls_configuration"><bdi class="secno">3.1.6 </bdi>TLS configuration</h4><a class="self-link" href="#tls_configuration" aria-label="Permalink for Section 3.1.6"></a></div><p>Connections between Inways, Outways, Managers of a Group are mTLS connections based on X.509 certificates as defined in [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc5280" title="Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile">RFC5280</a></cite>].</p>
<p>The certificate guarantees the identity of a Peer.</p>
<p>FSC places specific requirements on the subject fields of a certificate. <a href="https://www.rfc-editor.org/rfc/rfc5280#section-4.1.2.6">section 4.1.2.6</a> of[<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc5280" title="Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile">RFC5280</a></cite>] which are listed below</p>
<ul>
<li>Subject Alternative Name <a href="https://www.rfc-editor.org/rfc/rfc5280#section-4.1.2.6">section 4.1.2.6</a> of[<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc5280" title="Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile">RFC5280</a></cite>]: This should contain the Fully Qualified Domain Names (FQDN) of a Manager, Inway or Outway. For an Outway this FQDN does not have to resolve externally.</li>
<li>Subject Organization: This should contain to the name of the Organization.</li>
</ul>
<p>The representation and verification of domains specified in the X.509 certificate <strong><em class="rfc2119">MUST</em></strong> adhere to [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc6125" title="Representation and Verification of Domain-Based Application Service Identity within Internet Public Key Infrastructure Using X.509 (PKIX) Certificates in the Context of Transport Layer Security (TLS)">RFC6125</a></cite>]</p>
<section id="tls-version"><div class="header-wrapper"><h5 id="x3-1-6-1-tls-version"><bdi class="secno">3.1.6.1 </bdi>TLS Version</h5><a class="self-link" href="#tls-version" aria-label="Permalink for Section 3.1.6.1"></a></div>
<p>The TLS versions used between Peers in an Group <strong><em class="rfc2119">MUST</em></strong> be defined in the <a href="#profiles">Profile</a> of the Group.</p>
</section><section id="certificate-public-key-thumbprints"><div class="header-wrapper"><h5 id="certificate_thumbprints"><bdi class="secno">3.1.6.2 </bdi>Certificate &amp; Public key thumbprints</h5><a class="self-link" href="#certificate_thumbprints" aria-label="Permalink for Section 3.1.6.2"></a></div><p>FSC differentiates between two different types of thumbprints, often also called fingerprints. <em>Certificate</em> thumbprints and <em>Public Key</em> thumbprints.</p>
<p>Public Key thumbprints are used in FSC contracts, this enables the renewal of the certificate without invalidating the contract, since the Public Key thumbprint remains the same between Certificate renewals.
Certificate thumbprints are used in the certificate-bound access tokens <a href="https://www.rfc-editor.org/rfc/rfc8705#section-3">section 3</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc8705" title="OAuth 2.0 Mutual-TLS Client Authentication and Certificate-Bound Access Tokens">RFC8705</a></cite>]. FSC uses certificate-bound access tokens to authorize a connection to a Service. Certificate thumbprints are always part of a X.509 certificate and <strong><em class="rfc2119">MUST</em></strong> be created as described in <a href="https://www.rfc-editor.org/rfc/rfc7515#section-4.1.8">section 4.1.8</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc7515" title="JSON Web Signature (JWS)">RFC7515</a></cite>].</p>
<p>Within FSC both <em>Certificate thumbprints</em> and <em>Public Key</em> thumbprints uses the <code>sha256</code> thumbprint. </p>
</section></section><section id="error-handling"><div class="header-wrapper"><h4 id="error_handling"><bdi class="secno">3.1.7 </bdi>Error Handling</h4><a class="self-link" href="#error_handling" aria-label="Permalink for Section 3.1.7"></a></div><p>The Inway and Outway both have a single endpoint which proxies HTTP requests. 
In case of an error within the scope of FSC these components <strong><em class="rfc2119">MUST</em></strong> return the HTTP header <code>Fsc-Error-Code</code> which <strong><em class="rfc2119">MUST</em></strong> contain the code specifying the error. </p>
<p>The response body must contain an object as described in <code>.components/schemas/error</code> of the <a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">OpenAPI Specification</a>.  </p>
<p>The HTTP status codes that <strong><em class="rfc2119">MUST</em></strong> be used in combination with the HTTP header <code>Fsc-Error-Code</code> are defined in the sections 3.7.1.4 and 3.8.2.2.</p>
</section></section><section id="contracts"><div class="header-wrapper"><h3 id="x3-2-contracts"><bdi class="secno">3.2 </bdi>Contracts</h3><a class="self-link" href="#contracts" aria-label="Permalink for Section 3.2"></a></div>
<p>The content of a Contract is defined in the object <code>.components/schemas/contractContent</code> of the <a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">OpenAPI Specification</a></p>
<p>example Contract with a ServiceConnectionGrant</p>
<pre><code class="json hljs" aria-busy="false"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"iv"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"06338364-8305-7b74-8000-de4963503139"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"group_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fsc-example-group"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"validity"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"not_before"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1672527600</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"not_after"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1704063600</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"grants"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"GRANT_TYPE_SERVICE_CONNECTION"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"service"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"peer_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"00000000000000000001"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"example-service"</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"outway"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"peer_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"00000000000000000002"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"public_key_thumbprint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3a56f2e9269ac63f0d4394c46b96539da1625b6a985d38029ff89f34e490960c"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash_algorithm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HASH_ALGORITHM_SHA3_512"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1672527600</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<section id="contract-validation"><div class="header-wrapper"><h4 id="contract_validation"><bdi class="secno">3.2.1 </bdi>Contract Validation</h4><a class="self-link" href="#contract_validation" aria-label="Permalink for Section 3.2.1"></a></div><ul>
<li>A UUID <strong><em class="rfc2119">MUST</em></strong> be provided in the field <code>contract.iv</code>. The value must be unique. Each Peer is responsible for ensuring that only one Contract can exist with a given <code>iv</code>. </li>
<li>A hash algorithm is provided in the field <code>contract.content.hash_algorithm</code>.</li>
<li>The date provided in <code>contract.content.created_at</code> can not be in the future.</li>
<li>The Group ID of the Manager matches the Group ID defined in the field <code>contract.group_id</code>.</li>
<li>A valid date is provided in <code>contract.content.validity.not_before</code>. </li>
<li>A valid date is provided in <code>contract.content.validity.not_after</code>.</li>
<li>The date provided in <code>contract.content.validity.not_after</code> must be greater than the date provided in the field <code>contract.validity.not_before</code>.</li>
<li>The date provided in <code>contract.content.validity.not_after</code> must be in the future.</li>
<li>At least one Grant is set in the field <code>contract.content.grants</code>.</li>
<li>A <code>ServicePublicationGrant</code> or <code>DelegatedServicePublicationGrant</code> cannot be mixed with other Grants. Mixing Grant types with different use-cases is prohibited to prevent the creation of Contracts that are hard to maintain and validate.</li>
</ul>
<p>Per Grant type different validation rules apply.</p>
<section id="servicepublicationgrant"><div class="header-wrapper"><h5 id="service_publication_grant"><bdi class="secno">3.2.1.1 </bdi>ServicePublicationGrant</h5><a class="self-link" href="#service_publication_grant" aria-label="Permalink for Section 3.2.1.1"></a></div><p>The content of a ServicePublicationGrant is defined in the object <code>.components/schemas/grantServicePublication</code> of the <a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">OpenAPI Specification</a></p>
<p>Validation rules:</p>
<ul>
<li>The Peer ID provided by the X.509 certificate used by the Manager of the Directory Peer matches the value of the field <code>grant.data.directory.peer_id</code></li>
<li>The Peer ID provided by the X.509 certificate used by the Manager offering the Contract to the Directory matches the value of the field <code>grant.data.service.peer_id</code></li>
<li>A Service name which matches the regular expression <code>^[a-zA-Z0-9-._]{1,100}$</code> is provided in the field  <code>grant.data.service.name</code></li>
</ul>
<p>Signature requirements:  </p>
<ul>
<li>A signature is present with the Peer ID of the Peer defined in the field <code>grant.data.directory.peer_id</code></li>
<li>A signature is present with the Peer ID of the Peer defined in the field <code>grant.data.service.peer_id</code></li>
</ul>
</section><section id="delegatedservicepublicationgrant"><div class="header-wrapper"><h5 id="grant_delegated_service_publication"><bdi class="secno">3.2.1.2 </bdi>DelegatedServicePublicationGrant </h5><a class="self-link" href="#grant_delegated_service_publication" aria-label="Permalink for Section 3.2.1.2"></a></div><p><em>The Delegatee is the Peer specified in <code>grant.data.service.peer_id</code></em>
<em>The Delegator is the Peer specified in <code>grant.data.delegator.peer_id</code></em></p>
<p>Validation rules:</p>
<ul>
<li>The Peer ID provided by the X.509 certificate used by the Manager creating the delegation matches the value of the field <code>grant.data.delegator.peer_id</code></li>
<li>The Peer ID provided by the X.509 certificate used by the Manager of the Directory Peer matches the value of the field <code>grant.data.directory.peer_id</code></li>
<li>The Peer ID provided by the X.509 certificate used by the Manager providing the Service matches the value of the field <code>grant.data.service.peer_id</code></li>
<li>The validation rules of the field <code>Service</code> of the ServicePublicationGrant described in Core must be applied to the field <code>grant.data.service</code> of the DelegatedServicePublicationGrant</li>
</ul>
<p>Signature requirements:</p>
<ul>
<li>A signature is present with the subject serial number of the Peer defined the field <code>grant.data.service.peer_id</code></li>
<li>A signature is present with the subject serial number of the Peer defined the field <code>grant.data.directory.peer_id</code></li>
<li>A signature is present with the subject serial number of the Peer defined the field <code>grant.data.delegator.peer_id</code></li>
</ul>
</section><section id="serviceconnectiongrant"><div class="header-wrapper"><h5 id="service_connection_grant"><bdi class="secno">3.2.1.3 </bdi>ServiceConnectionGrant</h5><a class="self-link" href="#service_connection_grant" aria-label="Permalink for Section 3.2.1.3"></a></div><p>The content of a ServiceConnectionGrant is defined in the object <code>.components/schemas/grantServiceConnection</code> of the <a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">OpenAPI Specification</a></p>
<p>Validation rules:</p>
<ul>
<li>The Peer ID provided by the X.509 certificate used by the Manager of the Peer providing the Service matches the value of the field <code>grant.data.service.peer_id</code></li>
<li>The Peer ID provided by the X.509 certificate used by the Manager offering the Contract to the Service providing Peer matches the value of the field <code>grant.data.outway.peer_id</code></li>
<li>The Service provided in the field <code>grant.data.service.name</code> is offered by the Peer provided in the field <code>grant.data.service.peer_id</code></li>
<li>A Public key fingerprint also called thumbprint is provided in the field <code>grant.data.outway.public_key_thumbprint</code></li>
</ul>
<p>Signature requirements:</p>
<ul>
<li>A signature is present with the Peer ID of the Peer defined in the field <code>grant.data.outway.peer_id</code></li>
<li>A signature is present with the Peer ID of the Peer defined in the field <code>grant.data.service.peer_id</code></li>
</ul>
</section><section id="delegatedserviceconnectiongrant"><div class="header-wrapper"><h5 id="grant_delegated_service_connection"><bdi class="secno">3.2.1.4 </bdi>DelegatedServiceConnectionGrant</h5><a class="self-link" href="#grant_delegated_service_connection" aria-label="Permalink for Section 3.2.1.4"></a></div><p><em>The Delegatee is the Peer specified in <code>grant.data.outway.peer_id</code></em>
<em>The Delegator is the Peer specified in <code>grant.data.delegator.peer_id</code></em></p>
<p>Validation rules:</p>
<ul>
<li>The Peer ID provided by the X.509 certificate used by the Manager of the Peer creating the delegation matches the value of the field <code>grant.delegator.peer_id</code></li>
<li>The Peer ID provided by the X.509 certificate used by the Manager consuming the DelegatedServiceConnectionGrant matches with the value of the field <code>grant.outway.peer_id</code></li>
<li>The Peer ID provided by the X.509 certificate used by the Manager of the Peer providing the Service matches with the value of the field <code>grant.data.service.peer_id</code></li>
<li>The validation rules of the fields <code>Outway</code> and <code>Service</code> of the ServiceConnectionGrant described in Core must be applied to corresponding fields <code>grant.data.outway</code> and <code>grant.data.service</code> of the DelegatedServiceConnectionGrant</li>
<li>In case of a Service that is published on behalf of another Peer, The Peer ID provided by the X.509 certificate used by the Manager of the Peer delegating the publication of Service matches with the value of the field <code>grant.data.service.delegator.peer_id</code></li>
</ul>
<p>Signature requirements:</p>
<ul>
<li>A signature is present with the subject serial number of the Peer defined the field <code>grant.data.outway.peer_id</code></li>
<li>A signature is present with the subject serial number of the Peer defined the field <code>grant.data.delegator.peer_id</code></li>
<li>A signature is present with the subject serial number of the Peer defined the field <code>grant.data.service.peer_id</code></li>
<li>In case of a Service that is published on behalf of another Peer, a signature is present with the subject serial number of the Peer defined the field <code>grant.data.service.delegator.peer_id</code></li>
</ul>
</section></section><section id="signatures-0"><div class="header-wrapper"><h4 id="signatures"><bdi class="secno">3.2.2 </bdi>Signatures</h4><a class="self-link" href="#signatures" aria-label="Permalink for Section 3.2.2"></a></div><p>A signature <strong><em class="rfc2119">MUST</em></strong> follow the JSON Web Signature (JWS) format specified in [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc7515" title="JSON Web Signature (JWS)">RFC7515</a></cite>]</p>
<p>A signature on a Contract <strong><em class="rfc2119">SHOULD</em></strong> only be accepted if the Peer is present in one of the Grants as:</p>
<p><em>ServicePublicationGrant</em></p>
<ul>
<li><code>grant.data.directory.peer_id</code></li>
<li><code>grant.data.service.peer_id</code></li>
</ul>
<p><em>DelegatedServicePublicationGrant</em></p>
<ul>
<li><code>grant.data.directory.peer_id</code></li>
<li><code>grant.data.service.peer_id</code></li>
<li><code>grant.data.delegator.peer_id</code></li>
</ul>
<p><em>ServiceConnectionGrant</em></p>
<ul>
<li><code>grant.data.outway.peer_id</code></li>
<li><code>grant.data.service.peer_id</code></li>
<li><code>grant.data.service.delegator.peer_id</code></li>
</ul>
<p><em>DelegatedServiceConnectionGrant</em></p>
<ul>
<li><code>grant.data.outway.peer_id</code></li>
<li><code>grant.data.service.peer_id</code></li>
<li><code>grant.data.delegator.peer_id</code></li>
<li><code>grant.data.service.delegator.peer_id</code></li>
</ul>
<p>The JWS <strong><em class="rfc2119">MUST</em></strong> specify the certificate thumbprint of the keypair used to create the digital signature using the <code>x5t#S256</code> <a href="https://www.rfc-editor.org/rfc/rfc7515#section-4.1.8">section 4.1.8</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc7515" title="JSON Web Signature (JWS)">RFC7515</a></cite>] field of the <code>JOSE Header</code> <a href="https://www.rfc-editor.org/rfc/rfc7515#section-4">section 4</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc7515" title="JSON Web Signature (JWS)">RFC7515</a></cite>].</p>
<p>The JWS <strong><em class="rfc2119">MUST</em></strong> use the JWS Compact Serialization described in <a href="https://www.rfc-editor.org/rfc/rfc7515#section-7.1">section 7.1</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc7515" title="JSON Web Signature (JWS)">RFC7515</a></cite>]</p>
<p>The JWS <strong><em class="rfc2119">MUST</em></strong> be created using one of the following digital signature algorithms:</p>
<ul>
<li>RS256</li>
<li>RS384</li>
<li>RS512</li>
<li>ES256</li>
<li>ES384</li>
<li>ES512</li>
</ul>
<p>The JWS Payload as defined in <a href="https://www.rfc-editor.org/rfc/rfc7515#section-2">section 2</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc7515" title="JSON Web Signature (JWS)">RFC7515</a></cite>], <strong><em class="rfc2119">MUST</em></strong> contain a hash of the <code>contract.content</code> as described in the section <a href="#content_hash">Content Hash</a>, one of the signature types described in the <a href="#signature_types">signature type section</a> and a Unix timestamp of the sign date.</p>
<p>JWS Payload example:</p>
<pre><code class="JSON hljs json" aria-busy="false"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"contract_content_hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"--------"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"accept"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"signed_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1672527600</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<section id="payload-fields"><div class="header-wrapper"><h5 id="x3-2-2-1-payload-fields"><bdi class="secno">3.2.2.1 </bdi>Payload fields</h5><a class="self-link" href="#payload-fields" aria-label="Permalink for Section 3.2.2.1"></a></div>
<ul>
<li><code>contract_content_hash</code>, hash of the content of the Contract.</li>
<li><code>type</code>, type of signature.</li>
<li><code>signed_at</code> Unix timestamp of the sign date.</li>
</ul>
</section><section id="signature-types"><div class="header-wrapper"><h5 id="signature_types"><bdi class="secno">3.2.2.2 </bdi>Signature types</h5><a class="self-link" href="#signature_types" aria-label="Permalink for Section 3.2.2.2"></a></div><ul>
<li><code>accept</code>, Peer has accepted the contract</li>
<li><code>reject</code>, Peer has rejected the contract</li>
<li><code>revoke</code>, Peer has revoked the contract</li>
</ul>
</section></section><section id="the-content-hash"><div class="header-wrapper"><h4 id="content_hash"><bdi class="secno">3.2.3 </bdi>The content hash</h4><a class="self-link" href="#content_hash" aria-label="Permalink for Section 3.2.3"></a></div><p>A Peer should ensure that a signature is intended for the Contract.<br>This validation is done by comparing the hash of the received Contract with the hash in the signature.<br>The Validation <strong><em class="rfc2119">MUST</em></strong> be done every time a Peer receives a signature.  </p>
<p>The <code>contract_content_hash</code> of the signature payload contains the signature hash. The algorithm to create a <code>contract_content_hash</code> is described below. 
The algorithm ensures that the content hash is unique for a specific Contract content. Because a signature contains the content hash it becomes possible to guarantee that a signature is intended for a specific Contract.</p>
<ol>
<li>Create a byte array called <code>contentBytes</code>.</li>
<li>Convert <code>contract.content.group_id</code> to bytes and append the bytes to <code>contentBytes</code>.</li>
<li>Append <code>contract.content.iv</code> to <code>contentBytes</code>.</li>
<li>Convert <code>contract.content.validity.not_before</code> to bytes and append the bytes to <code>contentBytes</code>.</li>
<li>Convert <code>contract.content.validity.not_after</code> to bytes and append the bytes to <code>contentBytes</code>.</li>
<li>Convert <code>contract.content.created_at</code> to bytes and append the bytes to <code>contentBytes</code>.</li>
<li>Create an array of bytes arrays called <code>grantByteArrays</code></li>
<li>For each Grant in <code>contract.content.grants</code><ol>
<li>Create a Grant Hash for the Grant as documented in the <a href="#grant_hash">Grant Hash section</a>.</li>
<li>Convert the Grant Hash from string to bytes and store them in a byte array named <code>grantBytes</code>.</li>
<li>Append <code>grantBytes</code> to <code>grantByteArrays</code>.</li>
</ol>
</li>
<li>Sort the byte arrays in <code>grantByteArrays</code> in ascending order.</li>
<li>Append the bytes of <code>grantByteArrays</code> to <code>contentBytes</code>.</li>
<li>Hash the <code>contentBytes</code> using the hash algorithm described in <code>contract.content.algorithm</code>.</li>
<li>Encode the bytes of the hash using Base64 URL encoding with all trailing '=' characters omitted and without the inclusion of any line breaks, whitespace, or other additional characters.</li>
<li>Convert the value of <code>contract.content.algorithm</code> to an int32 and surround it with dollar signs (<code>$</code>). When using the <code>SHA3-512</code> algorithm this would result in <code>$1$</code>. 
To convert the hash algorithm to an integer see the <a href="#type_mapping_hash_algorithm">type mapping</a></li>
<li>Add <code>1$</code> as suffix to the string created in step 13. This is the enum <code>HASH_TYPE_CONTRACT</code> as defined in the field <code>.components.schemas.HashType</code> of <a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">the OpenAPI Specification</a> as int32. If the string created in step 13 is <code>$1$</code>, the result should now be <code>$1$1$</code></li>
<li>Add the Base64 generated in step 12 as suffix to the string generated in step 14.</li>
</ol>
<section id="data-types"><div class="header-wrapper"><h5 id="data_types"><bdi class="secno">3.2.3.1 </bdi>Data types</h5><a class="self-link" href="#data_types" aria-label="Permalink for Section 3.2.3.1"></a></div><ul>
<li><code>int32</code>: use <code>Little-endian</code> as endianness when converting to a byte array</li>
<li><code>int64</code>: use <code>Little-endian</code> as endianness when converting to a byte array</li>
<li><code>string</code>: use <code>utf-8</code> encoding when converting to a byte array</li>
</ul>
</section></section><section id="grant-hash"><div class="header-wrapper"><h4 id="grant_hash"><bdi class="secno">3.2.4 </bdi>Grant hash</h4><a class="self-link" href="#grant_hash" aria-label="Permalink for Section 3.2.4"></a></div><p>The Grant hash is used in the access token request to identify the Contract and Grant which contain the authorization for the connection to the Service. 
The <code>iv</code> (Initialization vector) field is included in the Grant hash to create a Grant hash that references to a single Contract. 
The Grant hash can be created by executing the following steps:</p>
<ol>
<li>Create a byte array named <code>grantBytes</code></li>
<li>Convert <code>contract.content.group_id</code> to bytes and append the bytes to <code>grantBytes</code>.</li>
<li>Convert <code>contract.content.iv</code> to bytes and append the bytes to <code>grantBytes</code>.</li>
<li>Convert the value of each field of the Grant to bytes and append the bytes to the <code>grantBytes</code> in the same order as the fields are defined in <a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">the OpenAPI Specification</a>.
To convert the Grant type to an integer see the <a href="#type_mapping_grant">type mapping</a> </li>
<li>Hash the <code>grantBytes</code> using the hash algorithm described in <code>contract.content.algorithm</code></li>
<li>Encode the bytes of the hash using Base64 URL encoding with all trailing '=' characters omitted and without the inclusion of any line breaks, whitespace, or other additional characters.</li>
<li>Convert the value of <code>contract.content.algorithm</code> to an int32 and enclose it with <code>$</code>. The int32 value per hash algorithm type is defined in the <a href="#type_mapping_hash_algorithm">type mapping</a>.. E.g. The enum <code>HASH_ALGORITHM_SHA3_512</code> becomes <code>$1$</code>.</li>
<li>Determine the <code>HashType</code> that matches with value of <code>Grant.type</code> and convert it to an int32 and add a <code>$</code> as suffix. The int32 value per hash type is defined in the <a href="#type_mapping_hash">type mapping</a>. E.g. The enum <code>HASH_TYPE_SERVICE_PUBLICATION_GRANT</code> becomes <code>2$</code>.</li>
<li>Combine the strings containing the hash algorithm (step 6) and Hash type (step 7). E.g. The hash algorithm <code>HASH_ALGORITHM_SHA3_512</code> and Grant Type <code>GRANT_TYPE_SERVICE_CONNECTION</code> should result in the string <code>$1$2$</code></li>
<li>Prefix the Base64 string generated in step 5 with the string generated in step 8.</li>
</ol>
</section><section id="type-mappings"><div class="header-wrapper"><h4 id="x3-2-5-type-mappings"><bdi class="secno">3.2.5 </bdi>Type mappings</h4><a class="self-link" href="#type-mappings" aria-label="Permalink for Section 3.2.5"></a></div>
<section id="hash-types"><div class="header-wrapper"><h5 id="type_mapping_hash"><bdi class="secno">3.2.5.1 </bdi>Hash types</h5><a class="self-link" href="#type_mapping_hash" aria-label="Permalink for Section 3.2.5.1"></a></div><table>
<thead>
<tr>
<th>Hash type</th>
<th>int32 value</th>
</tr>
</thead>
<tbody><tr>
<td>HASH_TYPE_CONTRACT</td>
<td>1</td>
</tr>
<tr>
<td>HASH_TYPE_SERVICE_PUBLICATION_GRANT</td>
<td>2</td>
</tr>
<tr>
<td>HASH_TYPE_SERVICE_CONNECTION_GRANT</td>
<td>3</td>
</tr>
<tr>
<td>HASH_TYPE_DELEGATED_SERVICE_CONNECTION_GRANT</td>
<td>4</td>
</tr>
<tr>
<td>HASH_TYPE_DELEGATED_SERVICE_PUBLICATION_GRANT</td>
<td>5</td>
</tr>
</tbody></table>
</section><section id="grant-types"><div class="header-wrapper"><h5 id="type_mapping_grant"><bdi class="secno">3.2.5.2 </bdi>Grant types</h5><a class="self-link" href="#type_mapping_grant" aria-label="Permalink for Section 3.2.5.2"></a></div><table>
<thead>
<tr>
<th>Hash type</th>
<th>int32 value</th>
</tr>
</thead>
<tbody><tr>
<td>GRANT_TYPE_SERVICE_PUBLICATION</td>
<td>1</td>
</tr>
<tr>
<td>GRANT_TYPE_SERVICE_CONNECTION</td>
<td>2</td>
</tr>
<tr>
<td>GRANT_TYPE_DELEGATED_SERVICE_CONNECTION</td>
<td>3</td>
</tr>
<tr>
<td>GRANT_TYPE_DELEGATED_SERVICE_PUBLICATION</td>
<td>4</td>
</tr>
</tbody></table>
</section><section id="hash-algorithms"><div class="header-wrapper"><h5 id="type_mapping_hash_algorithm"><bdi class="secno">3.2.5.3 </bdi>Hash algorithms</h5><a class="self-link" href="#type_mapping_hash_algorithm" aria-label="Permalink for Section 3.2.5.3"></a></div><table>
<thead>
<tr>
<th>Hash Algorithm</th>
<th>int32 value</th>
</tr>
</thead>
<tbody><tr>
<td>HASH_ALGORITHM_SHA3_512</td>
<td>1</td>
</tr>
</tbody></table>
</section><section id="service-types"><div class="header-wrapper"><h5 id="type_mapping_service"><bdi class="secno">3.2.5.4 </bdi>Service types</h5><a class="self-link" href="#type_mapping_service" aria-label="Permalink for Section 3.2.5.4"></a></div><table>
<thead>
<tr>
<th>Service Type</th>
<th>int32 values</th>
</tr>
</thead>
<tbody><tr>
<td>SERVICE_TYPE_SERVICE</td>
<td>1</td>
</tr>
<tr>
<td>SERVICE_TYPE_DELEGATED_SERVICE</td>
<td>2</td>
</tr>
</tbody></table>
</section></section></section><section id="access-token"><div class="header-wrapper"><h3 id="access_token"><bdi class="secno">3.3 </bdi>Access token</h3><a class="self-link" href="#access_token" aria-label="Permalink for Section 3.3"></a></div><p>The access token is a JSON Web Token (JWT) as specified in [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc7519" title="JSON Web Token (JWT)">RFC7519</a></cite>]</p>
<p>The JWT <strong><em class="rfc2119">MUST</em></strong> specify the thumbprint of the X.509 certificate used to sign the JWT using the <code>x5t#S256</code> <a href="https://www.rfc-editor.org/rfc/rfc7515#section-4.1.8">section 4.1.8</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc7515" title="JSON Web Signature (JWS)">RFC7515</a></cite>] field of the <code>JOSE Header</code>  <a href="https://www.rfc-editor.org/rfc/rfc7515#section-4">section 4</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc7515" title="JSON Web Signature (JWS)">RFC7515</a></cite>].</p>
<p>The JWT <strong><em class="rfc2119">MUST</em></strong> be created using one of the following digital signature algorithms:</p>
<ul>
<li>RS256</li>
<li>RS384</li>
<li>RS512</li>
<li>ES256</li>
<li>ES384</li>
<li>ES512</li>
</ul>
<p>The access token is a certificate-bound access token as specified in <a href="https://www.rfc-editor.org/rfc/rfc8705#section-3">section 3</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc8705" title="OAuth 2.0 Mutual-TLS Client Authentication and Certificate-Bound Access Tokens">RFC8705</a></cite>]</p>
<section id="jwt-payload"><div class="header-wrapper"><h4 id="x3-3-1-jwt-payload"><bdi class="secno">3.3.1 </bdi>JWT Payload</h4><a class="self-link" href="#jwt-payload" aria-label="Permalink for Section 3.3.1"></a></div>
<p>The payload of the JWT:</p>
<ul>
<li><em>gth(string):</em><br>The hash of the Grant that serves as basis for the authorization</li>
<li><em>gid(string):</em>
The ID of the Group</li>
<li><em>sub(string):</em>
The subject <a href="https://www.rfc-editor.org/rfc/rfc7519#section-4.1.2">section 4.1.2</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc7519" title="JSON Web Token (JWT)">RFC7519</a></cite>]. This should be the ID of the Peer for whom the token is intended </li>
<li><em>iss(string):</em>
The issuer <a href="https://www.rfc-editor.org/rfc/rfc7519#section-4.1.1">section 4.1.1</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc7519" title="JSON Web Token (JWT)">RFC7519</a></cite>]. The ID of the Peer who issued the token. I.e. the Peer who is offering the Service</li>
<li><em>svc(string):</em>
Name of the Service</li>
<li><em>aud(string):</em>
The audience <a href="https://www.rfc-editor.org/rfc/rfc7519#section-4.1.3">section 4.1.3</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc7519" title="JSON Web Token (JWT)">RFC7519</a></cite>]. This should be URI [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc3986" title="Uniform Resource Identifier (URI): Generic Syntax">RFC3986</a></cite>] of the Inway providing the Service. The URI is a URL that <strong><em class="rfc2119">MUST</em></strong> contain the scheme and port number used by the Inway</li>
<li><em>exp(int):</em>
Expiration time <a href="https://www.rfc-editor.org/rfc/rfc7519#section-4.1.4">section 4.1.4</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc7519" title="JSON Web Token (JWT)">RFC7519</a></cite>]</li>
<li><em>nbf(int):</em>
Not before  <a href="https://www.rfc-editor.org/rfc/rfc7519#section-4.1.5">section 4.1.5</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc7519" title="JSON Web Token (JWT)">RFC7519</a></cite>]</li>
<li><em>cnf(object):</em><ul>
<li><em>x5t#S256(string):</em>
  The thumbprint of the certificate that is allowed ot use the access token. [section 3.1] of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc8705" title="OAuth 2.0 Mutual-TLS Client Authentication and Certificate-Bound Access Tokens">RFC8705</a></cite>]</li>
</ul>
</li>
<li><em>act(object):</em><ul>
<li><em>sub(string):</em>
The ID of the Peer connecting to the Service on behalf of another Peer. The field <code>grant.data.delegator.peer_ID</code> of the DelegatedServiceConnectionGrant.</li>
</ul>
</li>
<li><em>pdi(string):</em>
The ID of the Peer delegating the publication of the Service to another Peer. The field <code>grant.data.service.delegator.peer_ID</code> of the ServiceConnectionGrant or DelegatedServiceConnectionGrant.</li>
<li><em>add(object):</em>
An object which can be used to provide additional data</li>
</ul>
<p>Example payload of a JWT for a Peer (<code>sub: 1234567890</code>) connecting to a Service (<code>svc: serviceName</code>) offered by a Peer(<code>iss: 1234567891</code>):</p>
<pre><code class="json hljs" aria-busy="false"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"gth"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$1$4$+PQI7we01qIfEwq4O5UioLKzjGBgRva6F5+bUfDlKxUjcY5yX1MRsn6NKquDbL8VcklhYO9sk18rHD6La3w/mg"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"gid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fsc.group.example.id"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sub"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1234567890"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"iss"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1234567891"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"svc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"serviceName"</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-attr">"aud"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://inway.com"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"exp"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1493726400</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"nbf"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1493722800</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"cnf"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"x5t#S256"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"DpAyDYakmVAQ4oOJC3UYLRk/ONRCqMj00TeGJemMiLA"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"add"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Example payload of a connection of a Peer (<code>sub: 1234567890</code>) to a Service (<code>svc: serviceName</code>) offered by a Peer (<code>iss: 1234567891</code>) on behalf of another Peer(<code>pdi: 1234567892</code>):</p>
<pre><code class="json hljs" aria-busy="false"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"gth"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$1$4$+PQI7we01qIfEwq4O5UioLKzjGBgRva6F5+bUfDlKxUjcY5yX1MRsn6NKquDbL8VcklhYO9sk18rHD6La3w/mg"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"gid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fsc.group.example.id"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sub"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1234567890"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"iss"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1234567891"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"pdi"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1234567892"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"svc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"serviceName"</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-attr">"aud"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://inway.com"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"exp"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1493726400</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"nbf"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1493722800</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"cnf"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"x5t#S256"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"DpAyDYakmVAQ4oOJC3UYLRk/ONRCqMj00TeGJemMiLA"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"add"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Example payload for a JWT of a Peer (<code>act.sub: 1234567892</code>) who is connecting on behalf of Peer (<code>sub: 1234567890</code>) to a Service (<code>svc: serviceName</code>) offered by a Peer (<code>iss: 1234567891</code>):</p>
<pre><code class="json hljs" aria-busy="false"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"gth"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$1$4$+PQI7we01qIfEwq4O5UioLKzjGBgRva6F5+bUfDlKxUjcY5yX1MRsn6NKquDbL8VcklhYO9sk18rHD6La3w/mg"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"gid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fsc.group.example.id"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sub"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1234567890"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"iss"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1234567891"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"svc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"serviceName"</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-attr">"aud"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://inway.com"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"exp"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1493726400</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"nbf"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1493722800</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"act"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sub"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1234567892"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"cnf"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"x5t#S256"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"DpAyDYakmVAQ4oOJC3UYLRk/ONRCqMj00TeGJemMiLA"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"add"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</section></section><section id="manager-0"><div class="header-wrapper"><h3 id="manager"><bdi class="secno">3.4 </bdi>Manager</h3><a class="self-link" href="#manager" aria-label="Permalink for Section 3.4"></a></div><p>The Manager is an essential component for each Peer in the Group. 
The Manager is responsible for:</p>
<ul>
<li>Receiving Contracts</li>
<li>Validating Contracts</li>
<li>Receiving Contract signatures (accept, reject, revoke)</li>
<li>Validating Contract signatures</li>
<li>Providing the X.509 certificates of the keypair of which the private key was used by the Peer to create signatures</li>
<li>Providing Contracts involving a specific Peer</li>
<li>Providing access tokens </li>
<li>Listing Peers</li>
<li>Listing Services</li>
</ul>
<p>It is <strong><em class="rfc2119">RECOMMENDED</em></strong> to implement the Manager functionality separate from the Inway functionality, in order to be able to have multiple Inways that are configured by one Manager.</p>
<section id="behavior"><div class="header-wrapper"><h4 id="x3-4-1-behavior"><bdi class="secno">3.4.1 </bdi>Behavior</h4><a class="self-link" href="#behavior" aria-label="Permalink for Section 3.4.1"></a></div>
<section id="authentication"><div class="header-wrapper"><h5 id="x3-4-1-1-authentication"><bdi class="secno">3.4.1.1 </bdi>Authentication</h5><a class="self-link" href="#authentication" aria-label="Permalink for Section 3.4.1.1"></a></div>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> only accept mTLS connections from other external Managers with an X.509 certificate that is signed by the TA of the Group.</p>
</section><section id="contracts-0"><div class="header-wrapper"><h5 id="x3-4-1-2-contracts"><bdi class="secno">3.4.1.2 </bdi>Contracts</h5><a class="self-link" href="#contracts-0" aria-label="Permalink for Section 3.4.1.2"></a></div>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> support Contracts containing Grants of the type ServicePublicationGrant and ServiceConnectionGrant.</p>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> validate Contracts using the rules described in <a href="#contract_validation">Contract validation section</a></p>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> persist the Peer ID, name and Manager address of each Peer with whom the Peer has negotiated Contracts.</p>
<p>It is <strong><em class="rfc2119">RECOMMENDED</em></strong> to implement a retry and backoff mechanism in case the Contract propagation fails.</p>
</section><section id="signatures-1"><div class="header-wrapper"><h5 id="x3-4-1-3-signatures"><bdi class="secno">3.4.1.3 </bdi>Signatures</h5><a class="self-link" href="#signatures-1" aria-label="Permalink for Section 3.4.1.3"></a></div>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> validate the signature according to the rules described in the <a href="#signatures">signature section</a>.</p>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> generate an error response if a signature is invalid.</p>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> propagate the signature to each of the Peers in the Contract when the Peer signs the Contract.</p>
<p>It is <strong><em class="rfc2119">RECOMMENDED</em></strong> to implement a retry and backoff mechanism in case the signature propagation fails.</p>
</section><section id="providing-x-509-certificates"><div class="header-wrapper"><h5 id="x3-4-1-4-providing-x-509-certificates"><bdi class="secno">3.4.1.4 </bdi>Providing X.509 certificates</h5><a class="self-link" href="#providing-x-509-certificates" aria-label="Permalink for Section 3.4.1.4"></a></div>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> provide X.509 certificates of the keypairs used to sign Contracts and access tokens.</p>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> provide the complete certificate chain excluding the root CA certificate used by the Group as Trust Anchor.</p>
</section><section id="providing-contracts"><div class="header-wrapper"><h5 id="x3-4-1-5-providing-contracts"><bdi class="secno">3.4.1.5 </bdi>Providing contracts</h5><a class="self-link" href="#providing-contracts" aria-label="Permalink for Section 3.4.1.5"></a></div>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> provide existing Contracts for a specific Peer. A Contract <strong><em class="rfc2119">SHOULD</em></strong> only be provided to a Peer if the Peer is present in one of the Grants of the Contract.</p>
</section><section id="tokens"><div class="header-wrapper"><h5 id="manager_tokens"><bdi class="secno">3.4.1.6 </bdi>Tokens</h5><a class="self-link" href="#manager_tokens" aria-label="Permalink for Section 3.4.1.6"></a></div><p>The Manager <strong><em class="rfc2119">MUST</em></strong> be able to provide an <a href="#access_token">access token</a> to Peers that have a valid Contract containing a ServiceConnectionGrant or DelegatedServiceConnectionGrant.</p>
<p>Before issuing an access token the Manager <strong><em class="rfc2119">MUST</em></strong> validate that:</p>
<ol>
<li>The <code>scope</code> provided in the token request contains a Grant hash that matches with a ServiceConnectionGrant or DelegatedServiceConnectionGrant of a valid Contract. </li>
<li>The <code>client_id</code> provided in the token request contains a PeerID that matches with the PeerID specified in the X.509 certificate of the client requesting the access token and later using the access token to make an API request.</li>
<li>The Manager is provided by a Peer with the same PeerID as specified in <code>grant.data.service.peer_id</code>.</li>
<li>The Manager is provided by a Peer who has an Inway which is offering the Service specified in <code>grant.data.service.name</code>. </li>
<li>The Peer ID specified by the X.509 certificate of the client requesting the access token matches the value of the field <code>grant.data.outway.peer_id</code>.</li>
<li>The X.509 certificate provided by the client contains the same public key as specified in <code>grant.data.outway.public_key_fingerprint</code></li>
</ol>
<p>The <code>cnf.x5t#S256</code> claim <strong><em class="rfc2119">MUST</em></strong> contain the certificate thumbprint of the X.509 certificate provided by the client requesting the token according to [section 3.1] of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc8705" title="OAuth 2.0 Mutual-TLS Client Authentication and Certificate-Bound Access Tokens">RFC8705</a></cite>].
The <code>act</code> claim <strong><em class="rfc2119">MUST</em></strong> be set when an access token is generated for a Peer who is connecting to the Service on behalf of another Peer. I.e. the authorization to connect has been granted using a DelegatedServiceConnectionGrant.
The <code>pdi</code> claim <strong><em class="rfc2119">MUST</em></strong> be set when an access token is generated for a Service which is being offered on behalf of another Peer. </p>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> include the address of the Inway in the field <code>aud</code> of the access token.</p>
</section><section id="services"><div class="header-wrapper"><h5 id="x3-4-1-7-services"><bdi class="secno">3.4.1.7 </bdi>Services</h5><a class="self-link" href="#services" aria-label="Permalink for Section 3.4.1.7"></a></div>
<p>The name of a Service <strong><em class="rfc2119">MUST</em></strong> be unique within the scope of a Peer.</p>
<p>The Peer is responsible for checking the uniqueness of a Service name.</p>
</section><section id="service-listing"><div class="header-wrapper"><h5 id="x3-4-1-8-service-listing"><bdi class="secno">3.4.1.8 </bdi>Service listing</h5><a class="self-link" href="#service-listing" aria-label="Permalink for Section 3.4.1.8"></a></div>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> list a Service when a valid Contract containing a ServicePublicationGrant or DelegatedServicePublicationGrant for the Service exists.</p>
</section><section id="peer-listing"><div class="header-wrapper"><h5 id="x3-4-1-9-peer-listing"><bdi class="secno">3.4.1.9 </bdi>Peer listing</h5><a class="self-link" href="#peer-listing" aria-label="Permalink for Section 3.4.1.9"></a></div>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> list the Peers with whom the Peer has negotiated Contracts or who announced themselves to the Peer.</p>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> persist the Peer ID, name and Manager address of each Peer with whom the Peer has negotiated Contracts.</p>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> persist the Peer ID, name and Manager address of each Peer who called the <code>announce</code> endpoint as specified in the <a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">OpenAPI Specification</a>.</p>
</section></section><section id="announce"><div class="header-wrapper"><h4 id="x3-4-2-announce"><bdi class="secno">3.4.2 </bdi>Announce</h4><a class="self-link" href="#announce" aria-label="Permalink for Section 3.4.2"></a></div>
<p>The <code>announce</code> is used to share the <code>Manager</code> address and <code>Peer</code> information among Peers. The <code>announce</code> is also used by the <code>Directory</code> to obtain the <code>Manager</code> addresses of all <code>Peers</code> in the <code>Group</code>. 
Each <code>Peer</code> <strong><em class="rfc2119">MUST</em></strong> call the <code>announce</code> endpoint of the Directory to register themselves as participant of the <code>Group</code>. </p>
<p>In addition to announcing to the <code>Directory</code> a Manager <strong><em class="rfc2119">SHOULD</em></strong> call the <code>announce</code> endpoint of the Peers with whom the Peer has negotiated Contracts when the address of Manager changes.</p>
</section><section id="interfaces"><div class="header-wrapper"><h4 id="manager_interface"><bdi class="secno">3.4.3 </bdi>Interfaces</h4><a class="self-link" href="#manager_interface" aria-label="Permalink for Section 3.4.3"></a></div><p>The Manager functionality <strong><em class="rfc2119">MUST</em></strong> implement an HTTP interface as specified in the <a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">OpenAPI Specification</a>.  </p>
</section><section id="fsc-manager-address"><div class="header-wrapper"><h4 id="x3-4-4-fsc-manager-address"><bdi class="secno">3.4.4 </bdi>FSC manager address</h4><a class="self-link" href="#fsc-manager-address" aria-label="Permalink for Section 3.4.4"></a></div>
<p>The Manager is required to include its public address as HTTP Header <code>Fsc-Manager-Address</code> in each POST or PUT request sent to another Manager.</p>
</section><section id="error-response"><div class="header-wrapper"><h4 id="x3-4-5-error-response"><bdi class="secno">3.4.5 </bdi>Error response</h4><a class="self-link" href="#error-response" aria-label="Permalink for Section 3.4.5"></a></div>
<p>The Manager implements two error formats </p>
<section id="oauth-2-0-error-response"><div class="header-wrapper"><h5 id="x3-4-5-1-oauth-2-0-error-response"><bdi class="secno">3.4.5.1 </bdi>OAuth 2.0 error response</h5><a class="self-link" href="#oauth-2-0-error-response" aria-label="Permalink for Section 3.4.5.1"></a></div>
<p>The <code>/token</code> endpoint <strong><em class="rfc2119">MUST</em></strong> return an error response as described in <a href="https://www.rfc-editor.org/rfc/rfc6749#section-5.2">section 5,2</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc6749" title="The OAuth 2.0 Authorization Framework">RFC6749</a></cite>].</p>
</section><section id="other-endpoints"><div class="header-wrapper"><h5 id="x3-4-5-2-other-endpoints"><bdi class="secno">3.4.5.2 </bdi>Other endpoints</h5><a class="self-link" href="#other-endpoints" aria-label="Permalink for Section 3.4.5.2"></a></div>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> return the error response object as described in <code>.components/schemas/error</code> of the <a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">OpenAPI Specification</a>.</p>
<p>The code field of the error response <strong><em class="rfc2119">MUST</em></strong> contain one of the codes defined as <code>.components.schemas.ManagerErrorCode</code> in the <a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">OpenAPI Specification</a>.  </p>
<p>The domain field of the error response <strong><em class="rfc2119">MUST</em></strong> be equal to <code>ERROR_DOMAIN_MANAGER</code>.  </p>
</section><section id="codes"><div class="header-wrapper"><h5 id="x3-4-5-3-codes"><bdi class="secno">3.4.5.3 </bdi>Codes</h5><a class="self-link" href="#codes" aria-label="Permalink for Section 3.4.5.3"></a></div>
<table>
<thead>
<tr>
<th>Error code</th>
<th>HTTP status code</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>ERROR_CODE_INCORRECT_GROUP_ID</td>
<td>422</td>
<td>The Group ID in the Contract does not match the GroupID of the receiving Manager</td>
</tr>
<tr>
<td>ERROR_CODE_PEER_NOT_PART_OF_CONTRACT</td>
<td>422</td>
<td>The Peer tried to submit or sign a Contract without being a Peer on the Contract</td>
</tr>
<tr>
<td>ERROR_CODE_SIGNATURE_CONTRACT_CONTENT_HASH_MISMATCH</td>
<td>422</td>
<td>The Peer tried to submit a signature with a Contract content hash that does not match the Contract</td>
</tr>
<tr>
<td>ERROR_CODE_PEER_CERTIFICATE_VERIFICATION_FAILED</td>
<td>400</td>
<td>The Peer provided a x.509 certificate signed by the trust anchor of the Group but the content is invalid. E.g the Peer ID is in a incorrect format</td>
</tr>
<tr>
<td>ERROR_CODE_PEER_ID_SIGNATURE_MISMATCH</td>
<td>422</td>
<td>The Peer submitted a signature that includes a Peer ID that does not match the ID of the submitting Peer</td>
</tr>
<tr>
<td>ERROR_CODE_SIGNATURE_VERIFICATION_FAILED</td>
<td>422</td>
<td>The Peer submitted a signature that could not be verified</td>
</tr>
<tr>
<td>ERROR_CODE_GRANT_COMBINATION_NOT_ALLOWED</td>
<td>422</td>
<td>The Peer submitted a Contract with a combination of Grants that is not allowed</td>
</tr>
<tr>
<td>ERROR_CODE_URL_PATH_CONTENT_HASH_MISMATCH</td>
<td>422</td>
<td>The Content Hash in the URL path does not match the Content Hash generated from the Contract Content in the request body</td>
</tr>
<tr>
<td>ERROR_CODE_UNKNOWN_HASH_ALGORITHM_HASH</td>
<td>422</td>
<td>The Hash Algorithm in the Contract Content hash or Grant Hash is not supported</td>
</tr>
<tr>
<td>ERROR_CODE_UNKNOWN_ALGORITHM_SIGNATURE</td>
<td>422</td>
<td>The Algorithm in the Signature is not supported</td>
</tr>
</tbody></table>
</section></section></section><section id="directory-0"><div class="header-wrapper"><h3 id="directory"><bdi class="secno">3.5 </bdi>Directory</h3><a class="self-link" href="#directory" aria-label="Permalink for Section 3.5"></a></div><p>The Directory is a Manager chosen by the Group to act as the Directory. </p>
<p>The Directory is used by Peers to:</p>
<ul>
<li>Discover Services</li>
<li>Discover Peers</li>
<li>Publish Services</li>
<li>Register themselves</li>
</ul>
<section id="behavior-0"><div class="header-wrapper"><h4 id="x3-5-1-behavior"><bdi class="secno">3.5.1 </bdi>Behavior</h4><a class="self-link" href="#behavior-0" aria-label="Permalink for Section 3.5.1"></a></div>
<section id="service-publication"><div class="header-wrapper"><h5 id="x3-5-1-1-service-publication"><bdi class="secno">3.5.1.1 </bdi>Service publication</h5><a class="self-link" href="#service-publication" aria-label="Permalink for Section 3.5.1.1"></a></div>
<p>Service publication is accomplished by offering a Contract to the Directory which contains one or more ServicePublicationGrants with each ServicePublicationGrant containing a single Service. Once the Directory and the Peer offering the Service have both signed the Contract, the Service is published in the Directory.</p>
<p>The Directory <strong><em class="rfc2119">MUST</em></strong> be able to sign Contracts with Grants of the type ServicePublicationGrant.</p>
<p>The Directory <strong><em class="rfc2119">MUST</em></strong> validate the ServicePublicationGrant in the Contract using the rules described in <a href="#service_publication_grant">ServicePublicationGrant section</a></p>
<p>Although multiple ServicePublicationGrants are allowed in a single Contract it is <strong><em class="rfc2119">RECOMMENDED</em></strong> to limit this to one per Contract. Adding multiple ServicePublicationGrants on a single Contract makes the Contract fragile. If the publication of one Service changes the whole Contract will be invalidated. </p>
</section></section></section><section id="outway"><div class="header-wrapper"><h3 id="x3-6-outway"><bdi class="secno">3.6 </bdi>Outway</h3><a class="self-link" href="#outway" aria-label="Permalink for Section 3.6"></a></div>
<p>The Outway is used by Peers to connect to a Service.<br>The Outway functions as a forwarding proxy that is responsible for setting up the connection to the Inway that is offering a Service.  </p>
<p>The Outway is responsible for:</p>
<ul>
<li>setting up mTLS connections with Inways</li>
<li>including a valid access token with each request</li>
<li>deliver the response from the Service to the client calling the Outway</li>
</ul>
<section id="behavior-1"><div class="header-wrapper"><h4 id="x3-6-1-behavior"><bdi class="secno">3.6.1 </bdi>Behavior</h4><a class="self-link" href="#behavior-1" aria-label="Permalink for Section 3.6.1"></a></div>
<section id="authentication-0"><div class="header-wrapper"><h5 id="x3-6-1-1-authentication"><bdi class="secno">3.6.1.1 </bdi>Authentication</h5><a class="self-link" href="#authentication-0" aria-label="Permalink for Section 3.6.1.1"></a></div>
<p>The Outway <strong><em class="rfc2119">MUST</em></strong> use mTLS when connecting to Inways with an X.509 certificate signed by the chosen TA of the Group.</p>
</section><section id="routing"><div class="header-wrapper"><h5 id="x3-6-1-2-routing"><bdi class="secno">3.6.1.2 </bdi>Routing</h5><a class="self-link" href="#routing" aria-label="Permalink for Section 3.6.1.2"></a></div>
<p>The Outway <strong><em class="rfc2119">MUST</em></strong> proxy the request to the address of the Inway specified in the field <code>aud</code> of the access token.</p>
<p>The Outway <strong><em class="rfc2119">MUST</em></strong> use an <a href="#access_token">access token</a> provided by the Peer specified in the <code>grant.data.service.peer_id</code> field of the ServiceConnectionGrant.</p>
<p>The Outway <strong><em class="rfc2119">MUST</em></strong> include an access token in the HTTP header <code>Fsc-Authorization</code> when proxying the HTTP request to the Inway.  </p>
<p>The Outway <strong><em class="rfc2119">MUST</em></strong> validate that the Group ID specified in the claim <code>gid</code> of the access token matches the Group ID of the Outway.</p>
<p>The Outway <strong><em class="rfc2119">MUST NOT</em></strong> alter the path of the HTTP Request.</p>
<p>Clients <strong><em class="rfc2119">MAY</em></strong> use TLS when communicating with the Outway.</p>
</section><section id="obtaining-access-tokens"><div class="header-wrapper"><h5 id="x3-6-1-3-obtaining-access-tokens"><bdi class="secno">3.6.1.3 </bdi>Obtaining access tokens</h5><a class="self-link" href="#obtaining-access-tokens" aria-label="Permalink for Section 3.6.1.3"></a></div>
<p>Access tokens are obtained using the Client Credentials flow <a href="https://www.rfc-editor.org/rfc/rfc6749#section-4.4">section 4,4</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc6749" title="The OAuth 2.0 Authorization Framework">RFC6749</a></cite>].
Access tokens <strong><em class="rfc2119">MUST</em></strong> be obtained by calling the <code>/token</code> endpoint defined in the <a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">OpenAPI Specification</a>.</p>
<p>To request a token via the Client Credentials flow the following information must be sent to the Manager which acts as an Authorization Server:</p>
<ul>
<li>GrantHash of a <code>Service Connection grant</code> or <code>Delegated Service Connection grant</code> provided in the <code>scope</code> field.</li>
<li>PeerID of the <code>Peer</code> making the request in the <code>client_id</code> field</li>
<li><code>client_credentials</code> in the <code>grant_type</code> field.</li>
</ul>
<p>The <code>GrantHash</code> provided in the request to the Manager acts as a reference to a <code>Grant</code> on a <code>Contract</code>. 
The Manager (Authorization Server) will perform the verification steps defined in the <a href="#manager_tokens">token section</a> before providing an access token.</p>
<p>The component retrieving the access token <strong><em class="rfc2119">MUST</em></strong> use mTLS to authenticate with the Authorization server (Manager) as defined in <a href="https://datatracker.ietf.org/doc/html/rfc8705#section-2.1">section 2.1</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc8705" title="OAuth 2.0 Mutual-TLS Client Authentication and Certificate-Bound Access Tokens">RFC8705</a></cite>].
The component retrieving the access token <strong><em class="rfc2119">MUST</em></strong> use an X.509 certificate signed by the chosen TA of the Group.
The Manager <strong><em class="rfc2119">MUST</em></strong> verify this client certificate and issue a token bound to this client certificate according to <a href="https://www.rfc-editor.org/rfc/rfc8705#section-3">section 3</a>.</p>
<p>
      </p><figure id="fig-obtaining-an-access-token">
        <img src="diagrams/seq-obtaining-an-access-token.svg" alt="Obtaining access token">
        <figcaption><a class="self-link" href="#fig-obtaining-an-access-token">Figure <bdi class="figno">10</bdi></a> <span class="fig-title">Obtaining an Access Token</span></figcaption>
      </figure>
    <p></p>
<p>Which component obtains an access token for a Service is an implementation detail and out of scope for this document.</p>
</section><section id="error-response-0"><div class="header-wrapper"><h5 id="x3-6-1-4-error-response"><bdi class="secno">3.6.1.4 </bdi>Error response</h5><a class="self-link" href="#error-response-0" aria-label="Permalink for Section 3.6.1.4"></a></div>
<p>If the Error has occurred in the Inway or Service the Outway <strong><em class="rfc2119">MUST</em></strong> return the error without altering the response. </p>
<p>The Outway <strong><em class="rfc2119">MUST</em></strong> return an error response defined in the <a href="#error_handling">Error handling section</a> when the error is produced by the Outway.</p>
<p>The code field of the error response <strong><em class="rfc2119">MUST</em></strong> contain one of the codes defined as <code>.components.schemas.OutwayErrorCode</code> in the <a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">OpenAPI Specification</a>.</p>
<p>The domain field of the error response <strong><em class="rfc2119">MUST</em></strong> be equal to <code>ERROR_DOMAIN_OUTWAY</code>.</p>
<section id="codes-0"><div class="header-wrapper"><h6 id="x3-6-1-4-1-codes"><bdi class="secno">3.6.1.4.1 </bdi>Codes</h6><a class="self-link" href="#codes-0" aria-label="Permalink for Section 3.6.1.4.1"></a></div>
<table>
<thead>
<tr>
<th>Error code</th>
<th>HTTP status code</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>ERROR_CODE_METHOD_UNSUPPORTED</td>
<td>405</td>
<td>The Outway received a request with an HTTP Method that is not supported. The CONNECT method is not supported.</td>
</tr>
</tbody></table>
</section></section></section></section><section id="inway"><div class="header-wrapper"><h3 id="x3-7-inway"><bdi class="secno">3.7 </bdi>Inway</h3><a class="self-link" href="#inway" aria-label="Permalink for Section 3.7"></a></div>
<p>The Inway is used by Peers to offer a Service to other Peers.<br>The Inway is a Reverse proxy that handles incoming connections from Outways and routes the request to the correct Service.</p>
<p>The Inway is responsible for:</p>
<ul>
<li>validating access tokens.</li>
<li>routing requests to the correct Service.</li>
<li>forwarding the access token to the Service which is being called.</li>
<li>returning the response from the Service to the Outway.</li>
</ul>
<section id="behavior-2"><div class="header-wrapper"><h4 id="x3-7-1-behavior"><bdi class="secno">3.7.1 </bdi>Behavior</h4><a class="self-link" href="#behavior-2" aria-label="Permalink for Section 3.7.1"></a></div>
<section id="authentication-1"><div class="header-wrapper"><h5 id="x3-7-1-1-authentication"><bdi class="secno">3.7.1.1 </bdi>Authentication</h5><a class="self-link" href="#authentication-1" aria-label="Permalink for Section 3.7.1.1"></a></div>
<p>The Inway <strong><em class="rfc2119">MUST</em></strong> only accept connections from Outways using mTLS with an X.509 certificate signed by the chosen TA of the Group.</p>
</section><section id="authorization"><div class="header-wrapper"><h5 id="x3-7-1-2-authorization"><bdi class="secno">3.7.1.2 </bdi>Authorization</h5><a class="self-link" href="#authorization" aria-label="Permalink for Section 3.7.1.2"></a></div>
<p>The Inway <strong><em class="rfc2119">MUST</em></strong> validate the access token provided in the HTTP <code>Fsc-Authorization</code>.   </p>
<p>The request <strong><em class="rfc2119">MUST</em></strong> be authorized if the access token meets the following conditions:  </p>
<ul>
<li>The access token is signed by the same Peer that owns Inway.</li>
<li>The access token is used by an Outway that uses the X.509 certificate to which the access token is bound. This is verified by applying the JWT Certificate Thumbprint Confirmation Method specified in <a href="https://datatracker.ietf.org/doc/html/rfc8705#section-3.1">section 3.1</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc8705" title="OAuth 2.0 Mutual-TLS Client Authentication and Certificate-Bound Access Tokens">RFC8705</a></cite>].</li>
<li>The Service specified in the access token is known to the Inway.</li>
<li>The Group ID specified in the claim <code>gid</code> of the access token matches the Group ID of the Inway.</li>
</ul>
</section><section id="routing-0"><div class="header-wrapper"><h5 id="x3-7-1-3-routing"><bdi class="secno">3.7.1.3 </bdi>Routing</h5><a class="self-link" href="#routing-0" aria-label="Permalink for Section 3.7.1.3"></a></div>
<p>The HTTP request <strong><em class="rfc2119">MUST</em></strong> contain the HTTP Header <code>Fsc-Authorization</code> which contains the access token obtained by the Outway.</p>
<p>The Inway <strong><em class="rfc2119">MUST</em></strong> proxy the HTTP request to the Service specified in the field <code>svc</code> of the access token.</p>
<p>The Inway <strong><em class="rfc2119">MUST</em></strong> not delete the HTTP Header <code>Fsc-Authorization</code> from the HTTP Request before forwarding the request to the Service.</p>
<p>The security of the connection between the Inway and the Service is out of scope for this document.        </p>
</section></section><section id="interfaces-0"><div class="header-wrapper"><h4 id="x3-7-2-interfaces"><bdi class="secno">3.7.2 </bdi>Interfaces</h4><a class="self-link" href="#interfaces-0" aria-label="Permalink for Section 3.7.2"></a></div>
<section id="proxy-endpoint"><div class="header-wrapper"><h5 id="x3-7-2-1-proxy-endpoint"><bdi class="secno">3.7.2.1 </bdi>Proxy Endpoint</h5><a class="self-link" href="#proxy-endpoint" aria-label="Permalink for Section 3.7.2.1"></a></div>
<p>The HTTP endpoint <code>/</code> <strong><em class="rfc2119">MUST</em></strong> be implemented.</p>
</section><section id="error-response-1"><div class="header-wrapper"><h5 id="x3-7-2-2-error-response"><bdi class="secno">3.7.2.2 </bdi>Error response</h5><a class="self-link" href="#error-response-1" aria-label="Permalink for Section 3.7.2.2"></a></div>
<p>The Inway <strong><em class="rfc2119">MUST</em></strong> return the error response of a Service to the Outway without altering the response.</p>
<p>The Inway <strong><em class="rfc2119">MUST</em></strong> return an error response defined in the <a href="#error_handling">Error handling section</a> when the error is produced by the Inway.</p>
<p>The code field of the error response <strong><em class="rfc2119">MUST</em></strong> contain one of the codes defined as <code>.components.schemas.InwayErrorCode</code> in the <a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">OpenAPI Specification</a>.</p>
<p>The domain field of the error response <strong><em class="rfc2119">MUST</em></strong> be equal to <code>ERROR_DOMAIN_INWAY</code>.</p>
<section id="codes-1"><div class="header-wrapper"><h6 id="x3-7-2-2-1-codes"><bdi class="secno">3.7.2.2.1 </bdi>Codes</h6><a class="self-link" href="#codes-1" aria-label="Permalink for Section 3.7.2.2.1"></a></div>
<table>
<thead>
<tr>
<th>Error code</th>
<th>HTTP status code</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>ERROR_CODE_ACCESS_TOKEN_MISSING</td>
<td>401</td>
<td>The HTTP header <code>Fsc-Authorization</code> does not contain an access token. In this scenario the HTTP header <code>WWW-Authenticate</code> <strong><em class="rfc2119">MUST</em></strong> be set to <code>Bearer</code></td>
</tr>
<tr>
<td>ERROR_CODE_ACCESS_TOKEN_INVALID</td>
<td>401</td>
<td>The provided access token is invalid. In this scenario the HTTP header <code>WWW-Authenticate</code> <strong><em class="rfc2119">MUST</em></strong> be set to <code>Bearer</code></td>
</tr>
<tr>
<td>ERROR_CODE_ACCESS_TOKEN_EXPIRED</td>
<td>401</td>
<td>The provided access token has expired. In this scenario the HTTP header <code>WWW-Authenticate</code> <strong><em class="rfc2119">MUST</em></strong> be set to <code>Bearer</code></td>
</tr>
<tr>
<td>ERROR_CODE_WRONG_GROUP_ID_IN_TOKEN</td>
<td>403</td>
<td>The Group ID specified in the access token does not match the ID of the Group of the Inway</td>
</tr>
<tr>
<td>ERROR_CODE_SERVICE_NOT_FOUND</td>
<td>404</td>
<td>The Service specified in the access token is not offered by the Inway</td>
</tr>
<tr>
<td>ERROR_CODE_SERVICE_UNREACHABLE</td>
<td>502</td>
<td>The Inway is unable to reach the Service</td>
</tr>
</tbody></table>
</section></section></section></section><section id="references-0"><div class="header-wrapper"><h3 id="x3-8-references"><bdi class="secno">3.8 </bdi>References</h3><a class="self-link" href="#references-0" aria-label="Permalink for Section 3.8"></a></div>
<p><a href="https://gitlab.com/commonground/standards/fsc/-/raw/master/manager.yaml">OpenAPI Specification</a></p>
</section></section>
    <section id="conformance"><div class="header-wrapper"><h2 id="x4-conformance"><bdi class="secno">4. </bdi>Conformance</h2><a class="self-link" href="#conformance" aria-label="Permalink for Section 4."></a></div><p>As well as sections marked as non-normative, all authoring guidelines, diagrams, examples, and notes in this specification are non-normative. Everything else in this specification is normative.</p><p>
        The key words <em class="rfc2119">MAY</em>, <em class="rfc2119">MUST</em>, <em class="rfc2119">MUST NOT</em>, <em class="rfc2119">RECOMMENDED</em>, and <em class="rfc2119">SHOULD</em> in this document
        are to be interpreted as described in
        <a href="https://datatracker.ietf.org/doc/html/bcp14">BCP 14</a>
        [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">RFC2119</a></cite>] [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc8174" title="Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words">RFC8174</a></cite>]
        when, and only when, they appear in all capitals, as shown here.
      </p></section>
    <section id="tof"><div class="header-wrapper"><h2 id="x5-list-of-figures"><bdi class="secno">5. </bdi>List of Figures</h2><a class="self-link" href="#tof" aria-label="Permalink for Section 5."></a></div><ul class="tof">
        <li class="tofline">
    <a class="tocxref" href="#fig-mtls-connections"><span class="self-link">Figure <bdi class="figno">1</bdi></span> <span class="fig-title">mTLS Connections</span></a>
  </li><li class="tofline">
    <a class="tocxref" href="#fig-contract-management"><span class="self-link">Figure <bdi class="figno">2</bdi></span> <span class="fig-title">Contract Management</span></a>
  </li><li class="tofline">
    <a class="tocxref" href="#fig-state-contract"><span class="self-link">Figure <bdi class="figno">3</bdi></span> <span class="fig-title">State Contract</span></a>
  </li><li class="tofline">
    <a class="tocxref" href="#fig-providing-a-service"><span class="self-link">Figure <bdi class="figno">4</bdi></span> <span class="fig-title">Providing a Service</span></a>
  </li><li class="tofline">
    <a class="tocxref" href="#fig-connecting-to-a-service"><span class="self-link">Figure <bdi class="figno">5</bdi></span> <span class="fig-title">Connecting to a Service</span></a>
  </li><li class="tofline">
    <a class="tocxref" href="#fig-connecting-to-a-service-that-is-offered-on-behalf-of-another-peer"><span class="self-link">Figure <bdi class="figno">6</bdi></span> <span class="fig-title">Connecting to a Service that is offered on behalf of another Peer</span></a>
  </li><li class="tofline">
    <a class="tocxref" href="#fig-delegate-a-connection-to-a-service"><span class="self-link">Figure <bdi class="figno">7</bdi></span> <span class="fig-title">Delegate a connection to a Service</span></a>
  </li><li class="tofline">
    <a class="tocxref" href="#fig-delegate-a-connection-to-a-service-that-is-offered-on-behalf-of-another-peer"><span class="self-link">Figure <bdi class="figno">8</bdi></span> <span class="fig-title">Delegate a connection to a Service that is offered on behalf of another Peer</span></a>
  </li><li class="tofline">
    <a class="tocxref" href="#fig-consuming-a-service"><span class="self-link">Figure <bdi class="figno">9</bdi></span> <span class="fig-title">Consuming a Service</span></a>
  </li><li class="tofline">
    <a class="tocxref" href="#fig-obtaining-an-access-token"><span class="self-link">Figure <bdi class="figno">10</bdi></span> <span class="fig-title">Obtaining an Access Token</span></a>
  </li>
      </ul></section>
  

<section id="references" class="appendix"><div class="header-wrapper"><h2 id="a-references"><bdi class="secno">A. </bdi>References</h2><a class="self-link" href="#references" aria-label="Permalink for Appendix A."></a></div><section id="normative-references">
    <div class="header-wrapper"><h3 id="a-1-normative-references"><bdi class="secno">A.1 </bdi>Normative references</h3><a class="self-link" href="#normative-references" aria-label="Permalink for Appendix A.1"></a></div>
    <dl class="bibliography"><dt id="bib-rfc2119">[RFC2119]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. S. Bradner.  IETF. March 1997. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>
    </dd><dt id="bib-rfc3986">[RFC3986]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc3986"><cite>Uniform Resource Identifier (URI): Generic Syntax</cite></a>. T. Berners-Lee; R. Fielding; L. Masinter.  IETF. January 2005. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc3986">https://www.rfc-editor.org/rfc/rfc3986</a>
    </dd><dt id="bib-rfc5279">[RFC5279]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc5279"><cite>A Uniform Resource Name (URN) Namespace for the 3rd Generation Partnership Project (3GPP)</cite></a>. A. Monrad; S. Loreto.  IETF. July 2008. Informational. URL: <a href="https://www.rfc-editor.org/rfc/rfc5279">https://www.rfc-editor.org/rfc/rfc5279</a>
    </dd><dt id="bib-rfc5280">[RFC5280]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc5280"><cite>Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile</cite></a>. D. Cooper; S. Santesson; S. Farrell; S. Boeyen; R. Housley; W. Polk.  IETF. May 2008. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc5280">https://www.rfc-editor.org/rfc/rfc5280</a>
    </dd><dt id="bib-rfc6125">[RFC6125]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc6125"><cite>Representation and Verification of Domain-Based Application Service Identity within Internet Public Key Infrastructure Using X.509 (PKIX) Certificates in the Context of Transport Layer Security (TLS)</cite></a>. P. Saint-Andre; J. Hodges.  IETF. March 2011. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc6125">https://www.rfc-editor.org/rfc/rfc6125</a>
    </dd><dt id="bib-rfc6749">[RFC6749]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc6749"><cite>The OAuth 2.0 Authorization Framework</cite></a>. D. Hardt, Ed..  IETF. October 2012. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc6749">https://www.rfc-editor.org/rfc/rfc6749</a>
    </dd><dt id="bib-rfc7515">[RFC7515]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc7515"><cite>JSON Web Signature (JWS)</cite></a>. M. Jones; J. Bradley; N. Sakimura.  IETF. May 2015. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc7515">https://www.rfc-editor.org/rfc/rfc7515</a>
    </dd><dt id="bib-rfc7519">[RFC7519]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc7519"><cite>JSON Web Token (JWT)</cite></a>. M. Jones; J. Bradley; N. Sakimura.  IETF. May 2015. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc7519">https://www.rfc-editor.org/rfc/rfc7519</a>
    </dd><dt id="bib-rfc8174">[RFC8174]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc8174"><cite>Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words</cite></a>. B. Leiba.  IETF. May 2017. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>
    </dd><dt id="bib-rfc8705">[RFC8705]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc8705"><cite>OAuth 2.0 Mutual-TLS Client Authentication and Certificate-Bound Access Tokens</cite></a>. B. Campbell; J. Bradley; N. Sakimura; T. Lodderstedt.  IETF. February 2020. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc8705">https://www.rfc-editor.org/rfc/rfc8705</a>
    </dd><dt id="bib-rfc9112">[RFC9112]</dt><dd>
      <a href="https://httpwg.org/specs/rfc9112.html"><cite>HTTP/1.1</cite></a>. R. Fielding, Ed.; M. Nottingham, Ed.; J. Reschke, Ed..  IETF. June 2022. Internet Standard. URL: <a href="https://httpwg.org/specs/rfc9112.html">https://httpwg.org/specs/rfc9112.html</a>
    </dd><dt id="bib-rfc9113">[RFC9113]</dt><dd>
      <a href="https://httpwg.org/specs/rfc9113.html"><cite>HTTP/2</cite></a>. M. Thomson, Ed.; C. Benfield, Ed..  IETF. June 2022. Proposed Standard. URL: <a href="https://httpwg.org/specs/rfc9113.html">https://httpwg.org/specs/rfc9113.html</a>
    </dd></dl>
  </section></section><p role="navigation" id="back-to-top">
    <a href="#title"><abbr title="Back to Top">↑</abbr></a>
  </p><script id="respec-dfn-panel">(() => {
// @ts-check
if (document.respec) {
  document.respec.ready.then(setupPanel);
} else {
  setupPanel();
}

function setupPanel() {
  const listener = panelListener();
  document.body.addEventListener("keydown", listener);
  document.body.addEventListener("click", listener);
}

function panelListener() {
  /** @type {HTMLElement} */
  let panel = null;
  return event => {
    const { target, type } = event;

    if (!(target instanceof HTMLElement)) return;

    // For keys, we only care about Enter key to activate the panel
    // otherwise it's activated via a click.
    if (type === "keydown" && event.key !== "Enter") return;

    const action = deriveAction(event);

    switch (action) {
      case "show": {
        hidePanel(panel);
        /** @type {HTMLElement} */
        const dfn = target.closest("dfn, .index-term");
        panel = document.getElementById(`dfn-panel-for-${dfn.id}`);
        const coords = deriveCoordinates(event);
        displayPanel(dfn, panel, coords);
        break;
      }
      case "dock": {
        panel.style.left = null;
        panel.style.top = null;
        panel.classList.add("docked");
        break;
      }
      case "hide": {
        hidePanel(panel);
        panel = null;
        break;
      }
    }
  };
}

/**
 * @param {MouseEvent|KeyboardEvent} event
 */
function deriveCoordinates(event) {
  const target = /** @type HTMLElement */ (event.target);

  // We prevent synthetic AT clicks from putting
  // the dialog in a weird place. The AT events sometimes
  // lack coordinates, so they have clientX/Y = 0
  const rect = target.getBoundingClientRect();
  if (
    event instanceof MouseEvent &&
    event.clientX >= rect.left &&
    event.clientY >= rect.top
  ) {
    // The event probably happened inside the bounding rect...
    return { x: event.clientX, y: event.clientY };
  }

  // Offset to the middle of the element
  const x = rect.x + rect.width / 2;
  // Placed at the bottom of the element
  const y = rect.y + rect.height;
  return { x, y };
}

/**
 * @param {Event} event
 */
function deriveAction(event) {
  const target = /** @type {HTMLElement} */ (event.target);
  const hitALink = !!target.closest("a");
  if (target.closest("dfn:not([data-cite]), .index-term")) {
    return hitALink ? "none" : "show";
  }
  if (target.closest(".dfn-panel")) {
    if (hitALink) {
      return target.classList.contains("self-link") ? "hide" : "dock";
    }
    const panel = target.closest(".dfn-panel");
    return panel.classList.contains("docked") ? "hide" : "none";
  }
  if (document.querySelector(".dfn-panel:not([hidden])")) {
    return "hide";
  }
  return "none";
}

/**
 * @param {HTMLElement} dfn
 * @param {HTMLElement} panel
 * @param {{ x: number, y: number }} clickPosition
 */
function displayPanel(dfn, panel, { x, y }) {
  panel.hidden = false;
  // distance (px) between edge of panel and the pointing triangle (caret)
  const MARGIN = 20;

  const dfnRects = dfn.getClientRects();
  // Find the `top` offset when the `dfn` can be spread across multiple lines
  let closestTop = 0;
  let minDiff = Infinity;
  for (const rect of dfnRects) {
    const { top, bottom } = rect;
    const diffFromClickY = Math.abs((top + bottom) / 2 - y);
    if (diffFromClickY < minDiff) {
      minDiff = diffFromClickY;
      closestTop = top;
    }
  }

  const top = window.scrollY + closestTop + dfnRects[0].height;
  const left = x - MARGIN;
  panel.style.left = `${left}px`;
  panel.style.top = `${top}px`;

  // Find if the panel is flowing out of the window
  const panelRect = panel.getBoundingClientRect();
  const SCREEN_WIDTH = Math.min(window.innerWidth, window.screen.width);
  if (panelRect.right > SCREEN_WIDTH) {
    const newLeft = Math.max(MARGIN, x + MARGIN - panelRect.width);
    const newCaretOffset = left - newLeft;
    panel.style.left = `${newLeft}px`;
    /** @type {HTMLElement} */
    const caret = panel.querySelector(".caret");
    caret.style.left = `${newCaretOffset}px`;
  }

  // As it's a dialog, we trap focus.
  // TODO: when <dialog> becomes a implemented, we should really
  // use that.
  trapFocus(panel, dfn);
}

/**
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function trapFocus(panel, dfn) {
  /** @type NodeListOf<HTMLAnchorElement> elements */
  const anchors = panel.querySelectorAll("a[href]");
  // No need to trap focus
  if (!anchors.length) return;

  // Move focus to first anchor element
  const first = anchors.item(0);
  first.focus();

  const trapListener = createTrapListener(anchors, panel, dfn);
  panel.addEventListener("keydown", trapListener);

  // Hiding the panel releases the trap
  const mo = new MutationObserver(records => {
    const [record] = records;
    const target = /** @type HTMLElement */ (record.target);
    if (target.hidden) {
      panel.removeEventListener("keydown", trapListener);
      mo.disconnect();
    }
  });
  mo.observe(panel, { attributes: true, attributeFilter: ["hidden"] });
}

/**
 *
 * @param {NodeListOf<HTMLAnchorElement>} anchors
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function createTrapListener(anchors, panel, dfn) {
  const lastIndex = anchors.length - 1;
  let currentIndex = 0;
  return event => {
    switch (event.key) {
      // Hitting "Tab" traps us in a nice loop around elements.
      case "Tab": {
        event.preventDefault();
        currentIndex += event.shiftKey ? -1 : +1;
        if (currentIndex < 0) {
          currentIndex = lastIndex;
        } else if (currentIndex > lastIndex) {
          currentIndex = 0;
        }
        anchors.item(currentIndex).focus();
        break;
      }

      // Hitting "Enter" on an anchor releases the trap.
      case "Enter":
        hidePanel(panel);
        break;

      // Hitting "Escape" returns focus to dfn.
      case "Escape":
        hidePanel(panel);
        dfn.focus();
        return;
    }
  };
}

/** @param {HTMLElement} panel */
function hidePanel(panel) {
  if (!panel) return;
  panel.hidden = true;
  panel.classList.remove("docked");
}
})()</script><div class="sidelabel">Vereniging van Nederlandse Gemeenten Standard - Definitive version</div><script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script></body></html>