<!DOCTYPE html><html lang="en"><head>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta content="text/html; charset=utf-8" http-equiv="content-type">
<meta name="generator" content="ReSpec 35.1.1">
<style>
dfn{cursor:pointer}
.dfn-panel{position:absolute;z-index:35;min-width:300px;max-width:500px;padding:.5em .75em;margin-top:.6em;font-family:"Helvetica Neue",sans-serif;font-size:small;background:#fff;background:var(--indextable-hover-bg,#fff);color:#000;color:var(--text,#000);box-shadow:0 1em 3em -.4em rgba(0,0,0,.3),0 0 1px 1px rgba(0,0,0,.05);box-shadow:0 1em 3em -.4em var(--tocsidebar-shadow,rgba(0,0,0,.3)),0 0 1px 1px var(--tocsidebar-shadow,rgba(0,0,0,.05));border-radius:2px}
.dfn-panel:not(.docked)>.caret{position:absolute;top:-9px}
.dfn-panel:not(.docked)>.caret::after,.dfn-panel:not(.docked)>.caret::before{content:"";position:absolute;border:10px solid transparent;border-top:0;border-bottom:10px solid #fff;border-bottom-color:var(--indextable-hover-bg,#fff);top:0}
.dfn-panel:not(.docked)>.caret::before{border-bottom:9px solid #a2a9b1;border-bottom-color:var(--indextable-hover-bg,#a2a9b1)}
.dfn-panel *{margin:0}
.dfn-panel b{display:block;color:#000;color:var(--text,#000);margin-top:.25em}
.dfn-panel ul a[href]{color:#333;color:var(--text,#333)}
.dfn-panel>div{display:flex}
.dfn-panel a.self-link{font-weight:700;margin-right:auto}
.dfn-panel .marker{padding:.1em;margin-left:.5em;border-radius:.2em;text-align:center;white-space:nowrap;font-size:90%;color:#040b1c}
.dfn-panel .marker.dfn-exported{background:#d1edfd;box-shadow:0 0 0 .125em #1ca5f940}
.dfn-panel .marker.idl-block{background:#8ccbf2;box-shadow:0 0 0 .125em #0670b161}
.dfn-panel a:not(:hover){text-decoration:none!important;border-bottom:none!important}
.dfn-panel a[href]:hover{border-bottom-width:1px}
.dfn-panel ul{padding:0}
.dfn-panel li{margin-left:1em}
.dfn-panel.docked{position:fixed;left:.5em;top:unset;bottom:2em;margin:0 auto;max-width:calc(100vw - .75em * 2 - .5em - .2em * 2);max-height:30vh;overflow:auto}
</style>
    
    
    
<title>FSC - Logging 1.0.0</title>
    
    
    
    
<link rel="shortcut icon" type="image/x-icon" href="https://gitdocumentatie.logius.nl/publicatie/respec/style/logos/logius.ico">
    
  
<style id="respec-mainstyle">
@keyframes pop{
0%{transform:scale(1,1)}
25%{transform:scale(1.25,1.25);opacity:.75}
100%{transform:scale(1,1)}
}
a.internalDFN{color:inherit;border-bottom:1px solid #99c;text-decoration:none}
a.externalDFN{color:inherit;border-bottom:1px dotted #ccc;text-decoration:none}
a.bibref{text-decoration:none}
.respec-offending-element:target{animation:pop .25s ease-in-out 0s 1}
.respec-offending-element,a[href].respec-offending-element{text-decoration:red wavy underline}
@supports not (text-decoration:red wavy underline){
.respec-offending-element:not(pre){display:inline-block}
.respec-offending-element{background:url(data:image/gif;base64,R0lGODdhBAADAPEAANv///8AAP///wAAACwAAAAABAADAEACBZQjmIAFADs=) bottom repeat-x}
}
#references :target{background:#eaf3ff;animation:pop .4s ease-in-out 0s 1}
cite .bibref{font-style:normal}
a[href].orcid{padding-left:4px;padding-right:4px}
a[href].orcid>svg{margin-bottom:-2px}
ol.tof,ul.tof{list-style:none outside none}
.caption{margin-top:.5em;font-style:italic}
#issue-summary>ul{column-count:2}
#issue-summary li{list-style:none;display:inline-block}
details.respec-tests-details{margin-left:1em;display:inline-block;vertical-align:top}
details.respec-tests-details>*{padding-right:2em}
details.respec-tests-details[open]{z-index:999999;position:absolute;border:thin solid #cad3e2;border-radius:.3em;background-color:#fff;padding-bottom:.5em}
details.respec-tests-details[open]>summary{border-bottom:thin solid #cad3e2;padding-left:1em;margin-bottom:1em;line-height:2em}
details.respec-tests-details>ul{width:100%;margin-top:-.3em}
details.respec-tests-details>li{padding-left:1em}
.self-link:hover{opacity:1;text-decoration:none;background-color:transparent}
aside.example .marker>a.self-link{color:inherit}
.header-wrapper{display:flex;align-items:baseline;position:relative;left:-.5em}
:is(h2,h3,h4,h5,h6):not(#toch2)+a.self-link{color:inherit;order:-1;position:relative;left:-.7em;font-size:1rem;opacity:.5}
:is(h2,h3,h4,h5,h6)+a.self-link::before{content:"§";text-decoration:none;color:var(--heading-text)}
:is(h2,h3)+a.self-link{top:-.2em}
:is(h4,h5,h6)+a.self-link::before{color:#000}
@media (max-width:767px){
dd{margin-left:0}
}
@media print{
.removeOnSave{display:none}
}
</style>
<style id="respec-nlgov">
img.license{float:left;padding-right:5px}
</style>
<meta name="description" content="Logging is an extension on the Federated Service Connectivity (FSC) standard FSC Core. It can only be used in addition to the FSC Core specification and if applicable the Delegation extension. 
The purpose of the Logging extension is to provide insights into transactions performed with services inside a FSC Group. The extension ensures Log records are uniformly described, stored and can be exchanged between Peers. 
The Logging extensions contains descriptions of the contents of Log Records, as well as a manner for other Peers to request Log records of transactions they have participated in as a Peer.">
<style>

  .sidelabel {
    position: fixed;
    -webkit-transform-origin: top right;
    right: 100%;
    top: 0;
    -webkit-transform: rotate(-90deg);
    padding: 4px 50px 4px 10px;
    color: white;
    white-space: nowrap;
    z-index: 1;
    background-color: #154273;
  }
</style>
<script id="initialUserConfig" type="application/json">{
  "nl_organisationName": "Vereniging van Nederlandse Gemeenten",
  "nl_organisationStylesURL": "https://gitdocumentatie.logius.nl/publicatie/respec/style/",
  "nl_organisationPublishURL": "https://gitdocumentatie.logius.nl/publicatie/",
  "logos": [
    {
      "src": "https://vng.nl/themes/custom/vng/logo.svg",
      "alt": "VNG",
      "id": "VNG",
      "height": 77,
      "width": 44,
      "url": "https://vng.nl/rubrieken/onderwerpen/standaarden"
    }
  ],
  "useLogo": true,
  "useLabel": true,
  "latestVersion": [
    "nl_organisationPublishURL",
    "pubDomain",
    "/",
    "shortName",
    "/"
  ],
  "thisVersion": [
    "nl_organisationPublishURL",
    "pubDomain",
    "/",
    "shortName",
    "/",
    "publishVersion",
    "/"
  ],
  "prevVersion": [
    "nl_organisationPublishURL",
    "pubDomain",
    "/",
    "shortName",
    "/",
    "previousPublishVersion",
    "/"
  ],
  "license": "cc-by",
  "addSectionLinks": true,
  "localizationStrings": {
    "en": {
      "wv": "Draft",
      "cv": "Recommendation",
      "vv": "Proposed recommendation",
      "def": "Definitive version",
      "basis": "Document",
      "eo": "Outdated version",
      "tg": "Rescinded version",
      "no": "Norm",
      "st": "Standard",
      "im": "Information model",
      "pr": "Guideline",
      "hr": "Guide",
      "wa": "Proposed recommendation",
      "al": "General",
      "bd": "Governance documentation",
      "bp": "Best practice"
    },
    "nl": {
      "wv": "Werkversie",
      "cv": "Consultatieversie",
      "vv": "Versie ter vaststelling",
      "def": "Vastgestelde versie",
      "basis": "Document",
      "eo": "Verouderde versie",
      "tg": "Teruggetrokken versie",
      "no": "Norm",
      "st": "Standaard",
      "im": "Informatiemodel",
      "pr": "Praktijkrichtlijn",
      "hr": "Handreiking",
      "wa": "Werkafspraak",
      "al": "Algemeen",
      "bd": "Beheerdocumentatie",
      "bp": "Best practice"
    }
  },
  "sotdText": {
    "nl": {
      "sotd": "Status van dit document",
      "def": "Dit is de definitieve versie van dit document. Wijzigingen naar aanleiding van consultaties zijn doorgevoerd.",
      "wv": "Dit is een werkversie die op elk moment kan worden gewijzigd, verwijderd of vervangen door andere documenten. Het is geen door het TO goedgekeurde consultatieversie.",
      "cv": "Dit is een door het TO goedgekeurde consultatieversie. Commentaar over dit document kan gestuurd worden naar ",
      "vv": "Dit is een definitief concept van de nieuwe versie van dit document. Wijzigingen naar aanleiding van consultaties zijn doorgevoerd.",
      "basis": "Dit is een document zonder officiële status."
    },
    "en": {
      "sotd": "Status of This Document",
      "def": "This is the definitive version of this document. Edits resulting from consultations have been applied.",
      "wv": "This is a draft that could be altered, removed or replaced by other documents. It is not a recommendation approved by TO.",
      "cv": "This is a proposed recommendation approved by TO. Comments regarding this document may be sent to ",
      "vv": "This is the definitive concept of this document. Edits resulting from consultations have been applied.",
      "basis": "This document has no official standing."
    }
  },
  "labelColor": {
    "def": "#154273",
    "wv": "#39870c"
  },
  "licenses": {
    "cc0": {
      "name": "Creative Commons 0 Public Domain Dedication",
      "short": "CC0",
      "url": "https://creativecommons.org/publicdomain/zero/1.0/",
      "image": "https://gitdocumentatie.logius.nl/publicatie/respec/media/logos/cc-zero.svg"
    },
    "cc-by": {
      "name": "Creative Commons Attribution 4.0 International Public License",
      "short": "CC-BY",
      "url": "https://creativecommons.org/licenses/by/4.0/legalcode",
      "image": "https://gitdocumentatie.logius.nl/publicatie/respec/media/logos/cc-by.svg"
    },
    "cc-by-nd": {
      "name": "Creative Commons Naamsvermelding-GeenAfgeleideWerken 4.0 Internationaal",
      "short": "CC-BY-ND",
      "url": "https://creativecommons.org/licenses/by-nd/4.0/legalcode.nl",
      "image": "https://gitdocumentatie.logius.nl/publicatie/respec/media/logos/cc-by-nd.svg"
    }
  },
  "localBiblio": {
    "SemVer": {
      "href": "https://semver.org",
      "title": "Semantic Versioning 2.0.0",
      "authors": [
        "T. Preston-Werner"
      ],
      "date": "June 2013"
    }
  },
  "specStatus": "DEF",
  "specType": "ST",
  "pubDomain": "fsc",
  "shortName": "logging",
  "publishDate": "2024-12-12",
  "publishVersion": "1.0.0",
  "previousMaturity": "VV",
  "editors": [
    {
      "name": "VNG Realisatie",
      "company": "VNG",
      "companyURL": "https://vng.nl/rubrieken/onderwerpen/standaarden"
    }
  ],
  "authors": [
    {
      "name": "Eelco Hotting",
      "company": "Hotting IT",
      "extras": [
        {
          "name": "Email",
          "href": "mailto:rfc@hotting.it"
        }
      ]
    },
    {
      "name": "Ronald Koster",
      "company": "PhillyShell",
      "extras": [
        {
          "name": "Email",
          "href": "mailto:rfc@phillyshell.nl"
        }
      ]
    },
    {
      "name": "Henk van Maanen",
      "company": "AceWorks",
      "extras": [
        {
          "name": "Email",
          "href": "mailto:henk.van.maanen@aceworks.nl"
        }
      ]
    },
    {
      "name": "Niels Dequeker",
      "company": "ND Software",
      "extras": [
        {
          "name": "Email",
          "href": "mailto:niels@nd-software.be"
        }
      ]
    },
    {
      "name": "Edward van Gelderen",
      "company": "vanG IT",
      "extras": [
        {
          "name": "Email",
          "href": "mailto:e.van.gelderen@vang.nl"
        }
      ]
    },
    {
      "name": "Pim Gaemers",
      "company": "Apily",
      "extras": [
        {
          "name": "Email",
          "href": "mailto:pim.gaemers@apily.dev"
        }
      ]
    }
  ],
  "github": "https://github.com/Logius-standaarden/fsc-logging"
}</script>
<link rel="stylesheet" href="https://gitdocumentatie.logius.nl/publicatie/respec/style/base.css"></head>
  <body class="h-entry toc-inline"><div class="head">
    <a class="logo" href="https://vng.nl/rubrieken/onderwerpen/standaarden"><img alt="VNG" height="77" id="VNG" src="https://vng.nl/themes/custom/vng/logo.svg" width="44">
  </a> <h1 id="title" class="title">FSC - Logging 1.0.0</h1>
    
    <h2>
      Vereniging van Nederlandse Gemeenten Standard<br>
      Definitive version
      <time class="dt-published" datetime="2024-12-12">December 12, 2024</time>
    </h2>
    <dl>
      <dt>This version:</dt><dd class="status">
              <a class="u-url status" href="https://gitdocumentatie.logius.nl/publicatie/fsc/logging/1.0.0/">https://gitdocumentatie.logius.nl/publicatie/fsc/logging/1.0.0/</a>
            </dd>
      <dt>Latest published version:</dt><dd>
              <a href="https://gitdocumentatie.logius.nl/publicatie/fsc/logging/">https://gitdocumentatie.logius.nl/publicatie/fsc/logging/</a>
            </dd>
      <dt>Latest editor's draft:</dt><dd><a href="https://logius-standaarden.github.io/fsc-logging/">https://logius-standaarden.github.io/fsc-logging/</a></dd>
      
      
      
      
      
      <dt>Editor:</dt>
      <dd class="editor p-author h-card vcard">
    <span class="p-name fn">VNG Realisatie</span> (<a class="p-org org h-org" href="https://vng.nl/rubrieken/onderwerpen/standaarden">VNG</a>)
  </dd>
      
      <dt>Authors:</dt><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Eelco Hotting</span> (<span class="p-org org h-org">Hotting IT</span>), <a href="mailto:rfc@hotting.it">Email</a>
  </dd><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Ronald Koster</span> (<span class="p-org org h-org">PhillyShell</span>), <a href="mailto:rfc@phillyshell.nl">Email</a>
  </dd><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Henk van Maanen</span> (<span class="p-org org h-org">AceWorks</span>), <a href="mailto:henk.van.maanen@aceworks.nl">Email</a>
  </dd><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Niels Dequeker</span> (<span class="p-org org h-org">ND Software</span>), <a href="mailto:niels@nd-software.be">Email</a>
  </dd><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Edward van Gelderen</span> (<span class="p-org org h-org">vanG IT</span>), <a href="mailto:e.van.gelderen@vang.nl">Email</a>
  </dd><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Pim Gaemers</span> (<span class="p-org org h-org">Apily</span>), <a href="mailto:pim.gaemers@apily.dev">Email</a>
  </dd>
      <dt>Participate:</dt><dd>
    <a href="https://github.com/Logius-standaarden/fsc-logging/">GitHub Logius-standaarden/fsc-logging</a>
  </dd><dd>
    <a href="https://github.com/Logius-standaarden/fsc-logging/issues/">File an issue</a>
  </dd><dd>
    <a href="https://github.com/Logius-standaarden/fsc-logging/commits/">Commit history</a>
  </dd><dd>
    <a href="https://github.com/Logius-standaarden/fsc-logging/pulls/">Pull requests</a>
  </dd>
    </dl>
    
    
    
    <p class="copyright">
          This document is licensed under 
          <a rel="license" href="https://creativecommons.org/licenses/by/4.0/legalcode" class="subfoot"><img class="license" src="https://gitdocumentatie.logius.nl/publicatie/respec/media/logos/cc-by.svg" alt="Logo Creative Commons Attribution 4.0 International Public License"><br> Creative Commons Attribution 4.0 International Public License</a>
        </p>
    <hr title="Separator for header">
  </div>
    <section id="abstract" class="introductory"><h2>Abstract</h2><p>Logging is an extension on the Federated Service Connectivity (FSC) standard <a href="../core/draft-fsc-core-00.html">FSC Core</a>. It can only be used in addition to the FSC Core specification and if applicable the Delegation extension. 
The purpose of the Logging extension is to provide insights into transactions performed with services inside a FSC Group. The extension ensures Log records are uniformly described, stored and can be exchanged between Peers. 
The Logging extensions contains descriptions of the contents of Log Records, as well as a manner for other Peers to request Log records of transactions they have participated in as a Peer. </p>
<p>In addition, this extension also described the format of uniquely identifying transactions occurring within an FSC Group. Which also can be used to establish an audit trail.</p>
</section>
    <section id="sotd" class="introductory"><h2>Status of This Document</h2><p>This is the definitive version of this document. Edits resulting from consultations have been applied.</p></section><nav id="toc"><h2 class="introductory" id="table-of-contents">Table of Contents</h2><ol class="toc"><li class="tocline"><a class="tocxref" href="#abstract">Abstract</a></li><li class="tocline"><a class="tocxref" href="#sotd">Status of This Document</a></li><li class="tocline"><a class="tocxref" href="#introduction"><bdi class="secno">1. </bdi>Introduction</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#purpose"><bdi class="secno">1.1 </bdi>Purpose</a></li><li class="tocline"><a class="tocxref" href="#overall-operation-of-logging"><bdi class="secno">1.2 </bdi>Overall Operation of Logging</a></li><li class="tocline"><a class="tocxref" href="#terminology"><bdi class="secno">1.3 </bdi>Terminology</a></li><li class="tocline"><a class="tocxref" href="#profiles"><bdi class="secno">1.4 </bdi>Profiles</a></li></ol></li><li class="tocline"><a class="tocxref" href="#architecture"><bdi class="secno">2. </bdi>Architecture</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#writing-to-the-transactionlog"><bdi class="secno">2.1 </bdi>Writing to the TransactionLog</a></li><li class="tocline"><a class="tocxref" href="#providing-the-transactionlog"><bdi class="secno">2.2 </bdi>Providing the TransactionLog</a></li><li class="tocline"><a class="tocxref" href="#connecting-log-records"><bdi class="secno">2.3 </bdi>Connecting log records</a></li></ol></li><li class="tocline"><a class="tocxref" href="#specification"><bdi class="secno">3. </bdi>Specification</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#log_record"><bdi class="secno">3.1 </bdi>Log record</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#access-token"><bdi class="secno">3.1.1 </bdi>Access token</a></li></ol></li><li class="tocline"><a class="tocxref" href="#manager"><bdi class="secno">3.2 </bdi>Manager</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#behavior"><bdi class="secno">3.2.1 </bdi>Behavior</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#providing-transactionlog-records"><bdi class="secno">3.2.1.1 </bdi>Providing TransactionLog records</a></li></ol></li><li class="tocline"><a class="tocxref" href="#interface"><bdi class="secno">3.2.2 </bdi>Interface</a></li></ol></li><li class="tocline"><a class="tocxref" href="#inway"><bdi class="secno">3.3 </bdi>Inway</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#behavior-0"><bdi class="secno">3.3.1 </bdi>Behavior</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#writing-to-the-transactionlog-0"><bdi class="secno">3.3.1.1 </bdi>Writing to the TransactionLog</a></li><li class="tocline"><a class="tocxref" href="#delegation"><bdi class="secno">3.3.1.2 </bdi>Delegation</a></li><li class="tocline"><a class="tocxref" href="#error-response"><bdi class="secno">3.3.1.3 </bdi>Error response</a></li></ol></li></ol></li><li class="tocline"><a class="tocxref" href="#outway"><bdi class="secno">3.4 </bdi>Outway</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#behavior-1"><bdi class="secno">3.4.1 </bdi>Behavior</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#writing-to-the-transactionlog-1"><bdi class="secno">3.4.1.1 </bdi>Writing to the TransactionLog</a></li><li class="tocline"><a class="tocxref" href="#delegation-0"><bdi class="secno">3.4.1.2 </bdi>Delegation</a></li><li class="tocline"><a class="tocxref" href="#error-response-0"><bdi class="secno">3.4.1.3 </bdi>Error response</a></li></ol></li></ol></li></ol></li><li class="tocline"><a class="tocxref" href="#conformance"><bdi class="secno">4. </bdi>Conformance</a></li><li class="tocline"><a class="tocxref" href="#tof"><bdi class="secno">5. </bdi>List of Figures</a></li><li class="tocline"><a class="tocxref" href="#references"><bdi class="secno">A. </bdi>References</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#normative-references"><bdi class="secno">A.1 </bdi>Normative references</a></li></ol></li></ol></nav>
    
    <section id="introduction"><div class="header-wrapper"><h2 id="x1-introduction"><bdi class="secno">1. </bdi>Introduction</h2><a class="self-link" href="#introduction" aria-label="Permalink for Section 1."></a></div>
<p>The Logging specification is an extension of the Federated Service Connectivity (FSC) Core specification. This extension describes how Peers should log requests made to Services and how Peers should provide log records to other Peers.</p>
<section id="purpose"><div class="header-wrapper"><h3 id="x1-1-purpose"><bdi class="secno">1.1 </bdi>Purpose</h3><a class="self-link" href="#purpose" aria-label="Permalink for Section 1.1"></a></div>
<p>Organizations should handle data in a transparent and responsible manner, partly this means that each organization should keep a log of data handled by the organization and provide insight into this log to relevant parties. FSC aims to uniform the logging of API requests to lay the groundwork for more extensive logging requirements like GDRP.
As it is impossible to create a logging standard that will satisfy the requirements of each individual organization, FSC will focus on logging the properties of an API request of which FSC can guarantee its authenticity e.g. the Peer making the request, the Peer receiving the request, the Service that is being called etc.
Organizations can use this as a foundation to create a log that will satisfy all their needs.</p>
</section><section id="overall-operation-of-logging"><div class="header-wrapper"><h3 id="x1-2-overall-operation-of-logging"><bdi class="secno">1.2 </bdi>Overall Operation of Logging</h3><a class="self-link" href="#overall-operation-of-logging" aria-label="Permalink for Section 1.2"></a></div>
<p>A client makes a request to a Service of the Group. The Outway will receive this request and write a log record with a unique ID before proxying the request to the Inway offering the Service. The Outway will include the unique ID in the request made to the Inway. The Inway also writes a log record containing the same unique ID before proxying the request to the Service.</p>
<p>Peers can request log records from other Peers. Peers provide only log records in which the requesting Peer is an active party.</p>
<p>Log records between Peers can be matched using the unique ID.</p>
</section><section id="terminology"><div class="header-wrapper"><h3 id="x1-3-terminology"><bdi class="secno">1.3 </bdi>Terminology</h3><a class="self-link" href="#terminology" aria-label="Permalink for Section 1.3"></a></div>
<p>This section lists terms (#header) and abbreviations that are used in this document. This document assumes that the reader is familiar with the Terminology of FSC Core.</p>
<p><em>Transaction:</em></p>
<p>A request made by a Peer to a Service.</p>
<p><em>TransactionLog:</em></p>
<p>A Peers log of Transactions. This log can contain both incoming and outgoing requests.</p>
<p><em>TransactionID:</em></p>
<p>A unique identifier which can be used to trace a Transaction between Peers.</p>
</section><section id="profiles"><div class="header-wrapper"><h3 id="x1-4-profiles"><bdi class="secno">1.4 </bdi>Profiles</h3><a class="self-link" href="#profiles" aria-label="Permalink for Section 1.4"></a></div>
<p>When using the Logging Extension the following additions <strong><em class="rfc2119">MUST</em></strong> be made to the <a href="../core/draft-fsc-core-00.html#profiles">FSC Profile</a>:</p>
<ol>
<li>Determine the expiration date for log records</li>
</ol>
<p>In addition, the mandatory decisions a Profile <strong><em class="rfc2119">MAY</em></strong> also contain additional agreements or restrictions within the Group. These are not technically required for the operation of FSC Logging extension, but can become mandatory within a Group. For example an additional set of rules to comply with local legislation.
Below are a few examples listed of these additional decisions for inspirational purposes:</p>
<ol>
<li>formatting restrictions on the TransactionID, for example UUIDv7</li>
</ol>
</section></section>
    <section id="architecture"><div class="header-wrapper"><h2 id="x2-architecture"><bdi class="secno">2. </bdi>Architecture</h2><a class="self-link" href="#architecture" aria-label="Permalink for Section 2."></a></div>
<section id="writing-to-the-transactionlog"><div class="header-wrapper"><h3 id="x2-1-writing-to-the-transactionlog"><bdi class="secno">2.1 </bdi>Writing to the TransactionLog</h3><a class="self-link" href="#writing-to-the-transactionlog" aria-label="Permalink for Section 2.1"></a></div>
<p>A Peer makes an HTTP request to a Service. The Outway will generate a unique ID for the Transaction and write a record to the TransactionLog <strong>before</strong> proxying the request to the Inway.
The Inway will parse the unique ID from the request and also write a record containing the unique ID to its own TransactionLog <strong>before</strong> proxying the request to the Service.</p>
<blockquote>
<p>The storage of the log record <em class="rfc2119">MAY</em> be implemented both synchronously or asynchronously. For both implementations it is <em class="rfc2119">REQUIRED</em> to receive confirmation that the log record is persisted in order to continue.
For example, you can introduce a message broker to improve performance. The message broker will ensure the records are persisted later on.</p>
</blockquote>
<p>
      </p><figure id="fig-write-to-the-transactionlog">
        <img src="diagrams/seq-write-transaction-log.svg" alt="Write to the TransactionLog">
        <figcaption><a class="self-link" href="#fig-write-to-the-transactionlog">Figure <bdi class="figno">1</bdi></a> <span class="fig-title">Write to the TransactionLog</span></figcaption>
      </figure>
    <p></p>
<ol>
<li>The client sends a request to the Outway.</li>
<li>The Outway generates a unique ID to be used as the TransactionID.</li>
<li>The Outway writes the record for transaction in the TransactionLog. </li>
<li>The TransactionLog confirms to the Outway that the record has been received.</li>
<li>The Outway proxies the request to the Inway and includes the TransactionID in the HTTP header <code>Fsc-Transaction-Id</code>.</li>
<li>The Inway reads the unique ID from the request.</li>
<li>The Inway writes the record for transaction in the TransactionLog.</li>
<li>The TransactionLog confirms to the Inway that the record has been received.</li>
<li>The Inway proxies the request to the Service and includes the TransactionID in an HTTP header.</li>
<li>The Service returns the response to the Inway.</li>
<li>The Inway return the response to the Outway.</li>
<li>The Outway returns the response to the client. The response includes the TransactionID in an HTTP header.</li>
</ol>
</section><section id="providing-the-transactionlog"><div class="header-wrapper"><h3 id="x2-2-providing-the-transactionlog"><bdi class="secno">2.2 </bdi>Providing the TransactionLog</h3><a class="self-link" href="#providing-the-transactionlog" aria-label="Permalink for Section 2.2"></a></div>
<p>A Peer provides the TransactionLog to other Peers. A Peer can request the records of the TransactionLog through the Manager of a Peer.
The Manager returns only logs records that involve the Peer requesting the log records.</p>
<p>
      </p><figure id="fig-provide-the-transactionlog">
        <img src="diagrams/seq-provide-transaction-log.svg" alt="Provide the TransactionLog">
        <figcaption><a class="self-link" href="#fig-provide-the-transactionlog">Figure <bdi class="figno">2</bdi></a> <span class="fig-title">Provide the TransactionLog</span></figcaption>
      </figure>
    <p></p>
<ol>
<li>Peer A requests the TransactionLog from Peer B.</li>
<li>Peer B returns the TransactionLog records that contain Peer B.</li>
</ol>
</section><section id="connecting-log-records"><div class="header-wrapper"><h3 id="x2-3-connecting-log-records"><bdi class="secno">2.3 </bdi>Connecting log records</h3><a class="self-link" href="#connecting-log-records" aria-label="Permalink for Section 2.3"></a></div>
<p>Each log record will have a TransactionID which is the unique ID for the Transaction. This ID is used to link the log records of a Transaction made across multiple Peers.
It is <strong><em class="rfc2119">RECOMMENDED</em></strong> to also add the TransactionID to logs created by other applications involved with the Transaction. E.g. the client making the request or the API offered as Service. This will enable Peers to provide a detailed audit trail of a request.</p>
</section></section>
    <section id="specification"><div class="header-wrapper"><h2 id="x3-specification"><bdi class="secno">3. </bdi>Specification</h2><a class="self-link" href="#specification" aria-label="Permalink for Section 3."></a></div>
<section id="log-record"><div class="header-wrapper"><h3 id="log_record"><bdi class="secno">3.1 </bdi>Log record</h3><a class="self-link" href="#log_record" aria-label="Permalink for Section 3.1"></a></div><p>The fields that a log record <strong><em class="rfc2119">MUST</em></strong> contain are described in the <a href="logging.yaml">OpenAPI Specification</a></p>
<section id="access-token"><div class="header-wrapper"><h4 id="x3-1-1-access-token"><bdi class="secno">3.1.1 </bdi>Access token</h4><a class="self-link" href="#access-token" aria-label="Permalink for Section 3.1.1"></a></div>
<p>Data from the access token <strong><em class="rfc2119">MUST</em></strong> be used to fill the following fields of the log record:</p>
<p><code>accessToken.gth</code> --&gt;  <code>logRecord.grant_hash</code>
<code>accessToken.sub</code> --&gt;  <code>logRecord.source.outway_peer_id</code>
<code>accessToken.iss</code> --&gt;  <code>logRecord.destination.service_peer_id</code>
<code>accessToken.svc</code> --&gt;  <code>logRecord.service_name</code></p>
<p>in case of a Peer making a request on behalf of another Peer an additional field <strong><em class="rfc2119">MUST</em></strong> be set:</p>
<p><code>accessToken.cdi</code> --&gt; <code>logRecord.source.delegator_peer_id</code></p>
<p>in case of a request made to a Service offered on behalf of another Peer and additional field <strong><em class="rfc2119">MUST</em></strong> be set:</p>
<p><code>accessToken.pdi</code> --&gt; <code>logRecord.destination.delegator_peer_id</code></p>
</section></section><section id="manager"><div class="header-wrapper"><h3 id="x3-2-manager"><bdi class="secno">3.2 </bdi>Manager</h3><a class="self-link" href="#manager" aria-label="Permalink for Section 3.2"></a></div>
<p>The FSC Log specification requires the Manager described in Core to be implemented.</p>
<section id="behavior"><div class="header-wrapper"><h4 id="x3-2-1-behavior"><bdi class="secno">3.2.1 </bdi>Behavior</h4><a class="self-link" href="#behavior" aria-label="Permalink for Section 3.2.1"></a></div>
<section id="providing-transactionlog-records"><div class="header-wrapper"><h5 id="x3-2-1-1-providing-transactionlog-records"><bdi class="secno">3.2.1.1 </bdi>Providing TransactionLog records</h5><a class="self-link" href="#providing-transactionlog-records" aria-label="Permalink for Section 3.2.1.1"></a></div>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> be able to provide log records to other Peers.</p>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> only return log records which match any of the following criteria:</p>
<ul>
<li>The Peer ID of the X.509 certificate used by the Peer requesting the log records matches the value of the field <code>logRecord.source.outway_peer_id</code></li>
<li>The Peer ID of the X.509 certificate used by the Peer requesting the log records matches the value of the field <code>logRecord.destination.service_peer_id</code></li>
<li>The Peer ID of the X.509 certificate used by the Peer requesting the log records matches the value of the field <code>logRecord.source.delegator_peer_id</code></li>
<li>The Peer ID of the X.509 certificate used by the Peer requesting the TransactionLog records matches the value of the field <code>logRecord.destination.delegator_peer_id</code></li>
</ul>
</section></section><section id="interface"><div class="header-wrapper"><h4 id="x3-2-2-interface"><bdi class="secno">3.2.2 </bdi>Interface</h4><a class="self-link" href="#interface" aria-label="Permalink for Section 3.2.2"></a></div>
<p>The Manager <strong><em class="rfc2119">MUST</em></strong> implement the interface described in the <a href="logging.yaml">OpenAPI Specification</a></p>
</section></section><section id="inway"><div class="header-wrapper"><h3 id="x3-3-inway"><bdi class="secno">3.3 </bdi>Inway</h3><a class="self-link" href="#inway" aria-label="Permalink for Section 3.3"></a></div>
<p>The FSC Log specification requires the Inway described in Core to be implemented.</p>
<section id="behavior-0"><div class="header-wrapper"><h4 id="x3-3-1-behavior"><bdi class="secno">3.3.1 </bdi>Behavior</h4><a class="self-link" href="#behavior-0" aria-label="Permalink for Section 3.3.1"></a></div>
<section id="writing-to-the-transactionlog-0"><div class="header-wrapper"><h5 id="x3-3-1-1-writing-to-the-transactionlog"><bdi class="secno">3.3.1.1 </bdi>Writing to the TransactionLog</h5><a class="self-link" href="#writing-to-the-transactionlog-0" aria-label="Permalink for Section 3.3.1.1"></a></div>
<p>The Inway <strong><em class="rfc2119">MUST</em></strong> write a record to the TransactionLog for each received request for a Service.</p>
<p>The Inway <strong><em class="rfc2119">MUST</em></strong> use the TransactionID provided by the Outway in the HTTP header <code>Fsc-Transaction-Id</code>.</p>
<p>The Inway <strong><em class="rfc2119">MUST</em></strong> add the TransactionID to the request sent to the Service using the HTTP header <code>Fsc-Transaction-Id</code>.</p>
<p>The TransactionLog record <strong><em class="rfc2119">MUST</em></strong> contain the fields described in the <a href="#log_record">log record section</a></p>
<p>The Inway <strong><em class="rfc2119">MUST</em></strong> deny the request if the record to the TransactionLog could not be written.</p>
</section><section id="delegation"><div class="header-wrapper"><h5 id="x3-3-1-2-delegation"><bdi class="secno">3.3.1.2 </bdi>Delegation</h5><a class="self-link" href="#delegation" aria-label="Permalink for Section 3.3.1.2"></a></div>
<p>When the requesting Peer is making the request on behalf of another Peer the source of a log record <strong><em class="rfc2119">MUST</em></strong> contain a sourceDelegated object as described in the <a href="logging.yaml">OpenAPI Specification</a>.</p>
<p>When the Service is published on behalf of another Peer the destination of a log record <strong><em class="rfc2119">MUST</em></strong> contain a destinationDelegated as described in the <a href="logging.yaml">OpenAPI Specification</a>.</p>
</section><section id="error-response"><div class="header-wrapper"><h5 id="x3-3-1-3-error-response"><bdi class="secno">3.3.1.3 </bdi>Error response</h5><a class="self-link" href="#error-response" aria-label="Permalink for Section 3.3.1.3"></a></div>
<p>This extension introduces a new error code for the Inway:</p>
<table>
<thead>
<tr>
<th>Error code</th>
<th>HTTP status code</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>TRANSACTION_LOG_WRITE_ERROR</td>
<td>500</td>
<td>The TransactionLog record could not be created</td>
</tr>
<tr>
<td>INVALID_LOG_RECORD_ID</td>
<td>400</td>
<td>The format of the <code>Fsc-Transaction-Id</code> header is not valid</td>
</tr>
<tr>
<td>MISSING_LOG_RECORD_ID</td>
<td>400</td>
<td>The the <code>Fsc-Transaction-Id</code> header is missing</td>
</tr>
</tbody></table>
</section></section></section><section id="outway"><div class="header-wrapper"><h3 id="x3-4-outway"><bdi class="secno">3.4 </bdi>Outway</h3><a class="self-link" href="#outway" aria-label="Permalink for Section 3.4"></a></div>
<p>The FSC Log specification requires the Outway described in Core to be implemented.</p>
<section id="behavior-1"><div class="header-wrapper"><h4 id="x3-4-1-behavior"><bdi class="secno">3.4.1 </bdi>Behavior</h4><a class="self-link" href="#behavior-1" aria-label="Permalink for Section 3.4.1"></a></div>
<section id="writing-to-the-transactionlog-1"><div class="header-wrapper"><h5 id="x3-4-1-1-writing-to-the-transactionlog"><bdi class="secno">3.4.1.1 </bdi>Writing to the TransactionLog</h5><a class="self-link" href="#writing-to-the-transactionlog-1" aria-label="Permalink for Section 3.4.1.1"></a></div>
<p>The Outway <strong><em class="rfc2119">MUST</em></strong> write a record to the TransactionLog for each request that will be sent to the Inway.</p>
<p>The Outway <strong><em class="rfc2119">MUST</em></strong> create a TransactionID which <strong><em class="rfc2119">MUST</em></strong> be unique for the transaction, the format is determined in a FSC Profile.</p>
<p>The Outway <strong><em class="rfc2119">MUST</em></strong> add the TransactionID to the request sent to the Inway using the HTTP header <code>Fsc-Transaction-Id</code>.</p>
<p>The TransactionLog record <strong><em class="rfc2119">MUST</em></strong> contain the fields described in the <a href="#transaction_log_record">TransactionLog record section</a></p>
<p>The Outway <strong><em class="rfc2119">MUST</em></strong> deny the request if the record to the TransactionLog could not be written.</p>
<p>The Outway <strong><em class="rfc2119">MUST</em></strong> add the TransactionID to the response sent to the Client using the HTTP header <code>Fsc-Transaction-Id</code>.</p>
</section><section id="delegation-0"><div class="header-wrapper"><h5 id="x3-4-1-2-delegation"><bdi class="secno">3.4.1.2 </bdi>Delegation</h5><a class="self-link" href="#delegation-0" aria-label="Permalink for Section 3.4.1.2"></a></div>
<p>When the requesting Peer is making the request on behalf of another Peer the source of a log record <strong><em class="rfc2119">MUST</em></strong> contain a sourceDelegated object as described in the <a href="logging.yaml">OpenAPI Specification</a>.</p>
<p>When the Service is published on behalf of another Peer the destination of a log record <strong><em class="rfc2119">MUST</em></strong> contain a destinationDelegated as described in the <a href="logging.yaml">OpenAPI Specification</a>.</p>
</section><section id="error-response-0"><div class="header-wrapper"><h5 id="x3-4-1-3-error-response"><bdi class="secno">3.4.1.3 </bdi>Error response</h5><a class="self-link" href="#error-response-0" aria-label="Permalink for Section 3.4.1.3"></a></div>
<p>This extension introduces a new error code for the Outway:</p>
<table>
<thead>
<tr>
<th>Error code</th>
<th>HTTP status code</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>TRANSACTION_LOG_WRITE_ERROR</td>
<td>500</td>
<td>The TransactionLog record could not be created</td>
</tr>
<tr>
<td>INVALID_LOG_RECORD_ID</td>
<td>400</td>
<td>The format of the <code>Fsc-Transaction-Id</code> header is not valid</td>
</tr>
<tr>
<td>MISSING_LOG_RECORD_ID</td>
<td>400</td>
<td>The the <code>Fsc-Transaction-Id</code> header is missing</td>
</tr>
</tbody></table>
</section></section></section></section>
    <section id="conformance"><div class="header-wrapper"><h2 id="x4-conformance"><bdi class="secno">4. </bdi>Conformance</h2><a class="self-link" href="#conformance" aria-label="Permalink for Section 4."></a></div><p>As well as sections marked as non-normative, all authoring guidelines, diagrams, examples, and notes in this specification are non-normative. Everything else in this specification is normative.</p><p>
        The key words <em class="rfc2119">MAY</em>, <em class="rfc2119">MUST</em>, <em class="rfc2119">RECOMMENDED</em>, and <em class="rfc2119">REQUIRED</em> in this document
        are to be interpreted as described in
        <a href="https://datatracker.ietf.org/doc/html/bcp14">BCP 14</a>
        [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">RFC2119</a></cite>] [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc8174" title="Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words">RFC8174</a></cite>]
        when, and only when, they appear in all capitals, as shown here.
      </p></section>
    <section id="tof"><div class="header-wrapper"><h2 id="x5-list-of-figures"><bdi class="secno">5. </bdi>List of Figures</h2><a class="self-link" href="#tof" aria-label="Permalink for Section 5."></a></div><ul class="tof">
        <li class="tofline">
    <a class="tocxref" href="#fig-write-to-the-transactionlog"><span class="self-link">Figure <bdi class="figno">1</bdi></span> <span class="fig-title">Write to the TransactionLog</span></a>
  </li><li class="tofline">
    <a class="tocxref" href="#fig-provide-the-transactionlog"><span class="self-link">Figure <bdi class="figno">2</bdi></span> <span class="fig-title">Provide the TransactionLog</span></a>
  </li>
      </ul></section>
  

<section id="references" class="appendix"><div class="header-wrapper"><h2 id="a-references"><bdi class="secno">A. </bdi>References</h2><a class="self-link" href="#references" aria-label="Permalink for Appendix A."></a></div><section id="normative-references">
    <div class="header-wrapper"><h3 id="a-1-normative-references"><bdi class="secno">A.1 </bdi>Normative references</h3><a class="self-link" href="#normative-references" aria-label="Permalink for Appendix A.1"></a></div>
    <dl class="bibliography"><dt id="bib-rfc2119">[RFC2119]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. S. Bradner.  IETF. March 1997. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>
    </dd><dt id="bib-rfc8174">[RFC8174]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc8174"><cite>Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words</cite></a>. B. Leiba.  IETF. May 2017. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>
    </dd></dl>
  </section></section><p role="navigation" id="back-to-top">
    <a href="#title"><abbr title="Back to Top">↑</abbr></a>
  </p><script id="respec-dfn-panel">(() => {
// @ts-check
if (document.respec) {
  document.respec.ready.then(setupPanel);
} else {
  setupPanel();
}

function setupPanel() {
  const listener = panelListener();
  document.body.addEventListener("keydown", listener);
  document.body.addEventListener("click", listener);
}

function panelListener() {
  /** @type {HTMLElement} */
  let panel = null;
  return event => {
    const { target, type } = event;

    if (!(target instanceof HTMLElement)) return;

    // For keys, we only care about Enter key to activate the panel
    // otherwise it's activated via a click.
    if (type === "keydown" && event.key !== "Enter") return;

    const action = deriveAction(event);

    switch (action) {
      case "show": {
        hidePanel(panel);
        /** @type {HTMLElement} */
        const dfn = target.closest("dfn, .index-term");
        panel = document.getElementById(`dfn-panel-for-${dfn.id}`);
        const coords = deriveCoordinates(event);
        displayPanel(dfn, panel, coords);
        break;
      }
      case "dock": {
        panel.style.left = null;
        panel.style.top = null;
        panel.classList.add("docked");
        break;
      }
      case "hide": {
        hidePanel(panel);
        panel = null;
        break;
      }
    }
  };
}

/**
 * @param {MouseEvent|KeyboardEvent} event
 */
function deriveCoordinates(event) {
  const target = /** @type HTMLElement */ (event.target);

  // We prevent synthetic AT clicks from putting
  // the dialog in a weird place. The AT events sometimes
  // lack coordinates, so they have clientX/Y = 0
  const rect = target.getBoundingClientRect();
  if (
    event instanceof MouseEvent &&
    event.clientX >= rect.left &&
    event.clientY >= rect.top
  ) {
    // The event probably happened inside the bounding rect...
    return { x: event.clientX, y: event.clientY };
  }

  // Offset to the middle of the element
  const x = rect.x + rect.width / 2;
  // Placed at the bottom of the element
  const y = rect.y + rect.height;
  return { x, y };
}

/**
 * @param {Event} event
 */
function deriveAction(event) {
  const target = /** @type {HTMLElement} */ (event.target);
  const hitALink = !!target.closest("a");
  if (target.closest("dfn:not([data-cite]), .index-term")) {
    return hitALink ? "none" : "show";
  }
  if (target.closest(".dfn-panel")) {
    if (hitALink) {
      return target.classList.contains("self-link") ? "hide" : "dock";
    }
    const panel = target.closest(".dfn-panel");
    return panel.classList.contains("docked") ? "hide" : "none";
  }
  if (document.querySelector(".dfn-panel:not([hidden])")) {
    return "hide";
  }
  return "none";
}

/**
 * @param {HTMLElement} dfn
 * @param {HTMLElement} panel
 * @param {{ x: number, y: number }} clickPosition
 */
function displayPanel(dfn, panel, { x, y }) {
  panel.hidden = false;
  // distance (px) between edge of panel and the pointing triangle (caret)
  const MARGIN = 20;

  const dfnRects = dfn.getClientRects();
  // Find the `top` offset when the `dfn` can be spread across multiple lines
  let closestTop = 0;
  let minDiff = Infinity;
  for (const rect of dfnRects) {
    const { top, bottom } = rect;
    const diffFromClickY = Math.abs((top + bottom) / 2 - y);
    if (diffFromClickY < minDiff) {
      minDiff = diffFromClickY;
      closestTop = top;
    }
  }

  const top = window.scrollY + closestTop + dfnRects[0].height;
  const left = x - MARGIN;
  panel.style.left = `${left}px`;
  panel.style.top = `${top}px`;

  // Find if the panel is flowing out of the window
  const panelRect = panel.getBoundingClientRect();
  const SCREEN_WIDTH = Math.min(window.innerWidth, window.screen.width);
  if (panelRect.right > SCREEN_WIDTH) {
    const newLeft = Math.max(MARGIN, x + MARGIN - panelRect.width);
    const newCaretOffset = left - newLeft;
    panel.style.left = `${newLeft}px`;
    /** @type {HTMLElement} */
    const caret = panel.querySelector(".caret");
    caret.style.left = `${newCaretOffset}px`;
  }

  // As it's a dialog, we trap focus.
  // TODO: when <dialog> becomes a implemented, we should really
  // use that.
  trapFocus(panel, dfn);
}

/**
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function trapFocus(panel, dfn) {
  /** @type NodeListOf<HTMLAnchorElement> elements */
  const anchors = panel.querySelectorAll("a[href]");
  // No need to trap focus
  if (!anchors.length) return;

  // Move focus to first anchor element
  const first = anchors.item(0);
  first.focus();

  const trapListener = createTrapListener(anchors, panel, dfn);
  panel.addEventListener("keydown", trapListener);

  // Hiding the panel releases the trap
  const mo = new MutationObserver(records => {
    const [record] = records;
    const target = /** @type HTMLElement */ (record.target);
    if (target.hidden) {
      panel.removeEventListener("keydown", trapListener);
      mo.disconnect();
    }
  });
  mo.observe(panel, { attributes: true, attributeFilter: ["hidden"] });
}

/**
 *
 * @param {NodeListOf<HTMLAnchorElement>} anchors
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function createTrapListener(anchors, panel, dfn) {
  const lastIndex = anchors.length - 1;
  let currentIndex = 0;
  return event => {
    switch (event.key) {
      // Hitting "Tab" traps us in a nice loop around elements.
      case "Tab": {
        event.preventDefault();
        currentIndex += event.shiftKey ? -1 : +1;
        if (currentIndex < 0) {
          currentIndex = lastIndex;
        } else if (currentIndex > lastIndex) {
          currentIndex = 0;
        }
        anchors.item(currentIndex).focus();
        break;
      }

      // Hitting "Enter" on an anchor releases the trap.
      case "Enter":
        hidePanel(panel);
        break;

      // Hitting "Escape" returns focus to dfn.
      case "Escape":
        hidePanel(panel);
        dfn.focus();
        return;
    }
  };
}

/** @param {HTMLElement} panel */
function hidePanel(panel) {
  if (!panel) return;
  panel.hidden = true;
  panel.classList.remove("docked");
}
})()</script><div class="sidelabel">Vereniging van Nederlandse Gemeenten Standard - Definitive version</div><script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script></body></html>